{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Digit Soft{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
        
        /* Tema claro */
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-tertiary: #e9ecef;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --text-muted: #868e96;
        --border-color: #dee2e6;
        --shadow: rgba(0, 0, 0, 0.1);
        --hover-bg: #f8f9fa;
    }

    [data-theme="dark"] {
        /* Tema oscuro */
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-tertiary: #3d3d3d;
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --text-muted: #888888;
        --border-color: #404040;
        --shadow: rgba(0, 0, 0, 0.3);
        --hover-bg: #3d3d3d;
    }

    body {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.3s ease;
    }

    .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        box-shadow: 0 4px 15px var(--shadow);
        transition: all 0.3s ease;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .theme-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px var(--shadow);
    }

    .gestion-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
    }

    .gestion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 25px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px var(--shadow);
        position: relative;
        overflow: hidden;
    }

    .gestion-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
        animation: shine 3s infinite;
    }

    @keyframes shine {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .gestion-title {
        font-size: 2rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 35px;
    }

    .stat-card {
        background: var(--bg-primary);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 20px var(--shadow);
        border-left: 5px solid var(--primary-color);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .stat-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 8px 35px var(--shadow);
    }

    .stat-card:nth-child(1) { border-left-color: var(--primary-color); }
    .stat-card:nth-child(2) { border-left-color: var(--success-color); }
    .stat-card:nth-child(3) { border-left-color: var(--warning-color); }
    .stat-card:nth-child(4) { border-left-color: var(--info-color); }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--primary-color);
        margin-bottom: 8px;
        background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    .table-container {
        background: var(--bg-primary);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 6px 25px var(--shadow);
        border: 1px solid var(--border-color);
    }

    .table-header {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        padding: 25px;
        border-bottom: 2px solid var(--border-color);
    }

    .table-title {
        font-size: 1.4rem;
        margin: 0;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 700;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        background: var(--bg-secondary);
        padding: 18px 15px;
        text-align: left;
        font-weight: 700;
        color: var(--text-primary);
        border-bottom: 2px solid var(--border-color);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-table td {
        padding: 18px 15px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: top;
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .data-table tr:hover {
        background: var(--hover-bg);
        transform: scale(1.005);
    }

    .data-table tr:hover td {
        box-shadow: inset 0 0 0 1px var(--primary-color);
    }

    .related-data {
        background: var(--bg-secondary);
        padding: 12px;
        border-radius: 8px;
        margin-top: 12px;
        font-size: 0.85rem;
        border: 1px solid var(--border-color);
    }

    .related-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .related-item:last-child {
        border-bottom: none;
    }

    .text-muted {
        color: var(--text-muted) !important;
    }

    .text-success {
        color: var(--success-color) !important;
        font-weight: 600;
    }

    .badge {
        display: inline-block;
        padding: 0.25em 0.6em;
        font-size: 0.75em;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }

    .badge-primary {
        color: #fff;
        background-color: #007bff;
    }

    .badge-success {
        color: #fff;
        background-color: #28a745;
    }

    .badge-warning {
        color: #212529;
        background-color: #ffc107;
    }

    .badge-info {
        color: #fff;
        background-color: #17a2b8;
    }

    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .pagination {
        display: flex;
        gap: 10px;
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .pagination a {
        display: block;
        padding: 8px 12px;
        text-decoration: none;
        color: #007bff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    .pagination a:hover {
        background-color: #e9ecef;
    }

    .pagination .current {
        padding: 8px 12px;
        background-color: #007bff;
        color: white;
        border: 1px solid #007bff;
        border-radius: 4px;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .btn-sm {
        padding: 8px 12px;
        font-size: 0.9rem;
        border-radius: 8px;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
    }

    .btn-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffc107, #ff8f00);
        color: white;
    }

    .btn-danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
    }

    .btn-info {
        background: linear-gradient(135deg, #17a2b8, #007bff);
        color: white;
    }

    .btn-primary, .btn-success, .btn-info, .btn-warning, .btn-danger {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }

    .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d, #5a6268);
        color: white;
    }

    .btn-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .btn-sm::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn-sm:hover::before {
        left: 100%;
    }

    /* Estilos para búsqueda */
    .search-input {
        width: 100%;
        padding: 12px 20px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 1rem;
        background: var(--card-bg);
        color: var(--text-color);
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-color)20;
    }

    .records-select {
        padding: 12px 15px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--card-bg);
        color: var(--text-color);
        cursor: pointer;
    }

    /* Estilos para modales */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background-color: var(--card-bg);
        margin: 2% auto;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        width: 95%;
        max-width: 800px;
        max-height: 90vh;
        box-shadow: 0 30px 60px rgba(0,0,0,0.4);
        animation: modalSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-radius: 15px 15px 0 0;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 700;
    }

    .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .close:hover {
        transform: scale(1.2);
    }

    .modal-body {
        padding: 30px 40px;
        flex: 1;
        overflow-y: auto;
        max-height: calc(90vh - 140px);
    }

    .modal-body::-webkit-scrollbar {
        width: 8px;
    }

    .modal-body::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 4px;
    }

    .modal-body::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 4px;
    }

    .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        border-radius: 0 0 15px 15px;
    }

    .modal-footer .btn-primary,
    .modal-footer .btn-secondary,
    .modal-footer .btn-danger {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .modal-footer button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .text-warning {
        color: #ffc107;
        font-weight: 600;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #dee2e6;
    }

    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .filters-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 200px;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 5px;
        color: #495057;
    }

    .filter-group select,
    .filter-group input {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    @media (max-width: 768px) {
        .gestion-header {
            flex-direction: column;
            text-align: center;
            gap: 15px;
        }

        .stats-cards {
            grid-template-columns: 1fr;
        }

        .data-table {
            font-size: 0.8rem;
        }

        .data-table th,
        .data-table td {
            padding: 10px 8px;
        }

        .filters-row {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group {
            min-width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Toggle de tema -->
<button class="theme-toggle" id="themeToggle" title="Cambiar tema">
    <i class="fas fa-moon" id="themeIcon"></i>
</button>

<div class="gestion-container">
    {% block gestion_header %}
    <div class="gestion-header">
        <h1 class="gestion-title">
            {% block header_icon %}<i class="fas fa-table"></i>{% endblock %}
            {{ title }}
        </h1>
        {% block header_actions %}{% endblock %}
    </div>
    {% endblock %}

    {% block stats_section %}{% endblock %}
    
    {% block filters_section %}
    <div class="filters-section">
        <div class="filters-row">
            <div class="filter-group">
                <label for="searchInput">
                    <i class="fas fa-search"></i> Búsqueda
                </label>
                <input type="text" id="searchInput" placeholder="Buscar en todos los campos..." class="search-input">
            </div>
            <div class="filter-group">
                <label for="recordsPerPage">
                    <i class="fas fa-list-ol"></i> Registros por página
                </label>
                <select id="recordsPerPage" class="records-select">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn-primary" onclick="clearSearch()">
                    <i class="fas fa-times"></i> Limpiar
                </button>
            </div>
            <div class="filter-group">
                <button class="btn-success" onclick="showAddForm()">
                    <i class="fas fa-plus"></i> Agregar Nuevo
                </button>
            </div>
            <div class="filter-group">
                <button class="btn-info" onclick="showInventoryReport()">
                    <i class="fas fa-chart-bar"></i> Reporte de Inventario
                </button>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block table_section %}
    <div class="table-container">
        <div class="table-header">
            <h2 class="table-title">
                {% block table_icon %}<i class="fas fa-list"></i>{% endblock %}
                {% block table_title %}Datos{% endblock %}
            </h2>
        </div>
        
        {% block table_content %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No hay datos disponibles</h3>
            <p>Aún no se han registrado datos en este módulo.</p>
        </div>
        {% endblock %}
        
        {% block pagination %}{% endblock %}
    </div>
    {% endblock %}
</div>

<!-- Modales -->
<!-- Modal de Detalles -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Detalles del Registro</h3>
            <span class="close" onclick="closeModal('detailModal')">&times;</span>
        </div>
        <div class="modal-body" id="detailContent">
            <!-- Contenido dinámico -->
        </div>
    </div>
</div>

<!-- Modal de Edición -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Editar Registro</h3>
            <span class="close" onclick="closeModal('editModal')">&times;</span>
        </div>
        <div class="modal-body" id="editContent">
            <!-- Formulario dinámico -->
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('editModal')">Cancelar</button>
            <button class="btn-primary" onclick="saveChanges()">Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h3>
            <span class="close" onclick="closeModal('deleteModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p>¿Está seguro que desea eliminar este registro?</p>
            <p class="text-warning"><strong>Esta acción no se puede deshacer.</strong></p>
            <div id="deleteDetails"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('deleteModal')">Cancelar</button>
            <button class="btn-danger" onclick="confirmDelete()" id="confirmDeleteBtn">Eliminar</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const body = document.body;
    
    // Cargar tema guardado
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);
    
    themeToggle.addEventListener('click', function() {
        const currentTheme = body.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
        localStorage.setItem('theme', newTheme);
    });
    
    function setTheme(theme) {
        body.setAttribute('data-theme', theme);
        themeIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        themeToggle.title = theme === 'light' ? 'Cambiar a modo oscuro' : 'Cambiar a modo claro';
    }
    
    // Animaciones de entrada para las tarjetas
    const cards = document.querySelectorAll('.stat-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.style.animation = 'slideInUp 0.6s ease forwards';
    });
    
    // Animación para la tabla
    const tableRows = document.querySelectorAll('.data-table tr');
    tableRows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.05}s`;
        row.style.animation = 'fadeInUp 0.4s ease forwards';
    });
});

// ===== FUNCIONES DE GESTIÓN DE DATOS =====

// Variables globales
let currentEditingId = null;
let currentDeleteId = null;

// Función para mostrar detalles
function viewDetails(id, type) {
    const data = getRowData(id);
    if (!data) return;
    
    const content = generateDetailContent(data, type);
    document.getElementById('detailContent').innerHTML = content;
    openModal('detailModal');
}

// Función para editar registro
function editRecord(id, type) {
    currentEditingId = id;
    const data = getRowData(id);
    if (!data) return;
    
    const form = generateEditForm(data, type);
    document.getElementById('editContent').innerHTML = form;
    openModal('editModal');
}

// Función para eliminar registro
function deleteRecord(id, type) {
    currentDeleteId = id;
    const data = getRowData(id);
    if (!data) return;
    
    const details = `<strong>ID:</strong> ${id}<br><strong>Registro:</strong> ${getRecordSummary(data, type)}`;
    document.getElementById('deleteDetails').innerHTML = details;
    openModal('deleteModal');
}

// Función para obtener datos de una fila
function getRowData(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (!row) return null;
    
    const cells = row.querySelectorAll('td');
    const data = {};
    
    // Extraer datos de cada celda
    cells.forEach((cell, index) => {
        const header = document.querySelector(`th:nth-child(${index + 1})`);
        if (header) {
            const key = header.textContent.trim().toLowerCase().replace(/\s+/g, '_');
            data[key] = cell.textContent.trim();
        }
    });
    
    return data;
}

// Función para generar contenido de detalles mejorado
function generateDetailContent(data, type) {
    let html = '';
    
    // Crear resumen principal
    const summary = getRecordSummary(data, type);
    const id = data.id || Object.values(data)[0] || 'N/A';
    
    html += `
        <div class="detail-summary">
            <h3><i class="fas fa-${getTypeIcon(type)}"></i> ${getTypeName(type)} #${id}</h3>
            <p>${summary}</p>
        </div>
    `;
    
    // Organizar datos por categorías
    const categorizedData = categorizeData(data, type);
    
    html += '<div class="detail-grid">';
    
    Object.entries(categorizedData).forEach(([category, items]) => {
        if (items.length > 0) {
            items.forEach(([key, value]) => {
                if (key !== 'acciones' && value && value.toString().trim() !== '') {
                    const label = formatLabel(key);
                    const formattedValue = formatValue(value, key);
                    
                    html += `
                        <div class="detail-item">
                            <strong><i class="fas fa-${getFieldIcon(key)}"></i> ${label}</strong>
                            <span>${formattedValue}</span>
                        </div>
                    `;
                }
            });
        }
    });
    
    html += '</div>';
    return html;
}

// Función auxiliar para obtener el icono del tipo
function getTypeIcon(type) {
    const icons = {
        'cliente': 'user',
        'producto': 'box',
        'proveedor': 'truck',
        'venta': 'chart-line',
        'compra': 'shopping-cart',
        'tecnico': 'tools',
        'garantia': 'shield-alt'
    };
    return icons[type] || 'info-circle';
}

// Función auxiliar para obtener el nombre del tipo
function getTypeName(type) {
    const names = {
        'cliente': 'Cliente',
        'producto': 'Producto',
        'proveedor': 'Proveedor',
        'venta': 'Venta',
        'compra': 'Compra',
        'tecnico': 'Técnico',
        'garantia': 'Garantía'
    };
    return names[type] || 'Registro';
}

// Función para categorizar datos
function categorizeData(data, type) {
    const categories = {
        'basic': [],
        'contact': [],
        'financial': [],
        'technical': [],
        'dates': [],
        'other': []
    };
    
    Object.entries(data).forEach(([key, value]) => {
        if (key === 'acciones') return;
        
        const lowerKey = key.toLowerCase();
        
        if (lowerKey.includes('nombre') || lowerKey.includes('id') || lowerKey.includes('titulo')) {
            categories.basic.push([key, value]);
        } else if (lowerKey.includes('telefono') || lowerKey.includes('email') || lowerKey.includes('correo') || lowerKey.includes('direccion')) {
            categories.contact.push([key, value]);
        } else if (lowerKey.includes('precio') || lowerKey.includes('valor') || lowerKey.includes('costo') || lowerKey.includes('cantidad')) {
            categories.financial.push([key, value]);
        } else if (lowerKey.includes('modelo') || lowerKey.includes('marca') || lowerKey.includes('especificacion') || lowerKey.includes('stock')) {
            categories.technical.push([key, value]);
        } else if (lowerKey.includes('fecha') || lowerKey.includes('creacion') || lowerKey.includes('modificacion')) {
            categories.dates.push([key, value]);
        } else {
            categories.other.push([key, value]);
        }
    });
    
    return categories;
}

// Función para formatear etiquetas
function formatLabel(key) {
    return key.replace(/_/g, ' ')
              .replace(/\b\w/g, l => l.toUpperCase())
              .replace('Id ', 'ID ')
              .replace('Nit ', 'NIT ');
}

// Función para formatear valores
function formatValue(value, key) {
    const lowerKey = key.toLowerCase();
    
    // Formatear precios y valores monetarios
    if (lowerKey.includes('precio') || lowerKey.includes('valor') || lowerKey.includes('costo')) {
        const num = parseFloat(value.toString().replace(/[^0-9.-]+/g, ''));
        if (!isNaN(num)) {
            return `<span class="money-value">$${num.toLocaleString('es-CO')}</span>`;
        }
    }
    
    // Formatear emails
    if (lowerKey.includes('email') || lowerKey.includes('correo')) {
        return `<a href="mailto:${value}" class="email-link">${value}</a>`;
    }
    
    // Formatear teléfonos
    if (lowerKey.includes('telefono')) {
        return `<a href="tel:${value}" class="phone-link">${value}</a>`;
    }
    
    // Formatear fechas
    if (lowerKey.includes('fecha')) {
        try {
            const date = new Date(value);
            if (!isNaN(date.getTime())) {
                return `<span class="date-value">${date.toLocaleDateString('es-CO')} ${date.toLocaleTimeString('es-CO')}</span>`;
            }
        } catch (e) {
            // Si no es una fecha válida, devolver el valor original
        }
    }
    
    // Formatear cantidades y números
    if (lowerKey.includes('cantidad') || lowerKey.includes('stock')) {
        const num = parseInt(value);
        if (!isNaN(num)) {
            return `<span class="quantity-value">${num} unidades</span>`;
        }
    }
    
    return value;
}

// Función para obtener iconos de campos
function getFieldIcon(key) {
    const lowerKey = key.toLowerCase();
    
    if (lowerKey.includes('nombre')) return 'tag';
    if (lowerKey.includes('email') || lowerKey.includes('correo')) return 'envelope';
    if (lowerKey.includes('telefono')) return 'phone';
    if (lowerKey.includes('direccion')) return 'map-marker-alt';
    if (lowerKey.includes('precio') || lowerKey.includes('valor')) return 'dollar-sign';
    if (lowerKey.includes('fecha')) return 'calendar';
    if (lowerKey.includes('cantidad') || lowerKey.includes('stock')) return 'cubes';
    if (lowerKey.includes('modelo') || lowerKey.includes('marca')) return 'cog';
    if (lowerKey.includes('id')) return 'hashtag';
    if (lowerKey.includes('documento') || lowerKey.includes('nit')) return 'id-card';
    
    return 'info';
}

// Función para generar formulario de edición
function generateEditForm(data, type) {
    let html = '<form id="editForm" class="edit-form">';
    
    Object.entries(data).forEach(([key, value]) => {
        if (key !== 'acciones' && key !== 'id') {
            const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `
                <div class="form-group">
                    <label for="${key}">${label}:</label>
                    <input type="text" id="${key}" name="${key}" value="${value}" class="form-control">
                </div>
            `;
        }
    });
    
    html += '</form>';
    return html;
}

// Función para obtener resumen del registro
function getRecordSummary(data, type) {
    // Intentar obtener el nombre o descripción más relevante
    const nameFields = ['nombre', 'cliente', 'producto', 'descripcion', 'titulo'];
    for (let field of nameFields) {
        if (data[field]) return data[field];
    }
    
    // Si no encuentra un campo de nombre, devolver los primeros datos
    const firstValue = Object.values(data).find(val => val && val.length > 0);
    return firstValue || 'Registro';
}

// Función para manejar la búsqueda
function initializeSearch() {
    const searchInput = document.getElementById('searchInput');
    const table = document.querySelector('.data-table');
    
    if (!searchInput || !table) return;
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const shouldShow = text.includes(searchTerm);
            
            row.style.display = shouldShow ? '' : 'none';
            
            if (shouldShow) {
                row.classList.add('search-highlight');
                setTimeout(() => row.classList.remove('search-highlight'), 300);
            }
        });
        
        updateResultCount();
    });
}

// Función para limpiar búsqueda
function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    const rows = document.querySelectorAll('.data-table tbody tr');
    
    if (searchInput) {
        searchInput.value = '';
    }
    
    rows.forEach(row => {
        row.style.display = '';
        row.classList.remove('search-highlight');
    });
    
    updateResultCount();
}

// Función para actualizar contador de resultados
function updateResultCount() {
    const visibleRows = document.querySelectorAll('.data-table tbody tr[style=""], .data-table tbody tr:not([style])').length;
    const totalRows = document.querySelectorAll('.data-table tbody tr').length;
    
    let countElement = document.getElementById('resultCount');
    if (!countElement) {
        countElement = document.createElement('div');
        countElement.id = 'resultCount';
        countElement.className = 'result-count';
        const searchInput = document.getElementById('searchInput');
        if (searchInput && searchInput.parentNode) {
            searchInput.parentNode.appendChild(countElement);
        }
    }
    
    countElement.textContent = `Mostrando ${visibleRows} de ${totalRows} registros`;
}

// Funciones de modales
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Animación de entrada
        setTimeout(() => {
            modal.querySelector('.modal-content').style.transform = 'scale(1)';
            modal.querySelector('.modal-content').style.opacity = '1';
        }, 10);
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        const content = modal.querySelector('.modal-content');
        content.style.transform = 'scale(0.9)';
        content.style.opacity = '0';
        
        setTimeout(() => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }, 300);
    }
}

// Función para guardar cambios
function saveChanges() {
    if (!currentEditingId) return;
    
    const form = document.getElementById('editForm');
    if (!form) return;
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Aquí puedes implementar la llamada AJAX a Django
    console.log('Guardando cambios para ID:', currentEditingId, 'Datos:', data);
    
    // Simular guardado exitoso
    showNotification('Cambios guardados correctamente', 'success');
    closeModal('editModal');
    
    // Actualizar la fila en la tabla
    updateRowInTable(currentEditingId, data);
}

// Función para reabastecer producto
function restockProduct(productId) {
    const quantity = prompt('Ingrese la cantidad a reabastecer:', '10');
    if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
        console.log(`Reabasteciendo producto ${productId} con ${quantity} unidades`);
        showNotification(`Producto reabastecido con ${quantity} unidades`, 'success');
        
        // Aquí puedes implementar la llamada AJAX a Django
        // actualizar el stock en la interfaz
        const row = document.querySelector(`tr[data-id="${productId}"]`);
        if (row) {
            const stockCell = row.querySelector('td:nth-child(5)'); // Ajustar según la posición
            if (stockCell) {
                const currentStock = parseInt(stockCell.textContent) || 0;
                const newStock = currentStock + parseInt(quantity);
                stockCell.textContent = newStock;
                stockCell.classList.add('updated');
                setTimeout(() => stockCell.classList.remove('updated'), 1000);
            }
        }
    }
}

// Función para confirmar eliminación
function confirmDelete() {
    if (!currentDeleteId) return;
    
    // Aquí puedes implementar la llamada AJAX a Django
    console.log('Eliminando registro con ID:', currentDeleteId);
    
    // Simular eliminación exitosa
    showNotification('Registro eliminado correctamente', 'success');
    closeModal('deleteModal');
    
    // Remover la fila de la tabla
    const row = document.querySelector(`tr[data-id="${currentDeleteId}"]`);
    if (row) {
        row.style.animation = 'slideOutRight 0.3s ease forwards';
        setTimeout(() => row.remove(), 300);
    }
}

// Función para mostrar notificaciones
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // Estilos inline para la notificación
    Object.assign(notification.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        padding: '15px 25px',
        backgroundColor: type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8',
        color: 'white',
        borderRadius: '8px',
        zIndex: '9999',
        animation: 'slideInRight 0.3s ease forwards'
    });
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Función para actualizar fila en tabla
function updateRowInTable(id, data) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (!row) return;
    
    const cells = row.querySelectorAll('td');
    let cellIndex = 0;
    
    Object.entries(data).forEach(([key, value]) => {
        if (key !== 'acciones' && cellIndex < cells.length - 1) {
            cells[cellIndex].textContent = value;
            cells[cellIndex].classList.add('updated');
            setTimeout(() => cells[cellIndex].classList.remove('updated'), 1000);
            cellIndex++;
        }
    });
}

// Inicializar funcionalidades cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    initializeSearch();
    updateResultCount();
    
    // Agregar atributos data-id a las filas si no los tienen
    const rows = document.querySelectorAll('.data-table tbody tr');
    rows.forEach((row, index) => {
        if (!row.getAttribute('data-id')) {
            // Intentar obtener ID de la primera celda
            const firstCell = row.querySelector('td');
            if (firstCell) {
                const id = firstCell.textContent.replace('#', '').trim();
                row.setAttribute('data-id', id);
            }
        }
    });
    
    // Cerrar modales al hacer clic fuera
    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                closeModal(modal.id);
            }
        });
    };
});

// Animaciones CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .stat-card, .data-table tr {
        opacity: 0;
    }
    
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100px);
        }
    }
    
    .search-highlight {
        background-color: var(--primary-color) !important;
        color: white !important;
        transition: all 0.3s ease;
    }
    
    .updated {
        background-color: #28a745 !important;
        color: white !important;
        animation: pulse 0.5s ease;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 10px;
    }
    
    .detail-item {
        padding: 20px;
        background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-secondary) 100%);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 15px var(--shadow-light);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .detail-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    }
    
    .detail-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px var(--shadow-medium);
    }
    
    .detail-item strong {
        color: var(--primary-color);
        display: block;
        margin-bottom: 8px;
        font-weight: 700;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .detail-item span {
        color: var(--text-primary);
        font-size: 1rem;
        line-height: 1.5;
        word-wrap: break-word;
    }
    
    .detail-summary {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 25px;
        margin: -30px -40px 30px -40px;
        position: relative;
    }
    
    .detail-summary::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 0;
        width: 100%;
        height: 20px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%);
    }
    
    .detail-summary h3 {
        margin: 0 0 10px 0;
        font-size: 1.5rem;
        font-weight: 800;
    }
    
    .detail-summary p {
        margin: 0;
        opacity: 0.9;
        font-size: 1rem;
    }
    
    .edit-form {
        display: grid;
        gap: 20px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-color);
    }
    
    .form-control {
        padding: 12px 15px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text-color);
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-color)20;
    }
    
    .result-count {
        margin-top: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
        font-style: italic;
    }
    
    .notification {
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        font-weight: 600;
    }
    
    /* Estilos responsivos para modales */
    @media (max-width: 768px) {
        .modal-content {
            width: 95%;
            max-width: 95%;
            margin: 2% auto;
            max-height: 95vh;
        }
        
        .modal-body {
            padding: 20px;
            max-height: calc(95vh - 120px);
        }
        
        .detail-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .detail-summary {
            margin: -20px -20px 20px -20px;
            padding: 20px;
        }
        
        .detail-item {
            padding: 15px;
        }
    }
    
    @media (max-width: 480px) {
        .modal-header {
            padding: 15px 20px;
        }
        
        .modal-header h3 {
            font-size: 1.1rem;
        }
        
        .close {
            font-size: 24px;
        }
    }
    
    /* Estilos para valores formateados */
    .money-value {
        color: #28a745;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .email-link {
        color: var(--primary-color);
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .email-link:hover {
        text-decoration: underline;
        color: var(--secondary-color);
    }
    
    .phone-link {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
    }
    
    .phone-link:hover {
        color: var(--secondary-color);
    }
    
    .date-value {
        color: var(--text-secondary);
        font-style: italic;
    }
    
    .quantity-value {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .detail-item i {
        margin-right: 8px;
        opacity: 0.8;
        width: 16px;
        text-align: center;
    }
    
    /* Estilos para modal de agregar */
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .form-control {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .inventory-alert {
        background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
        border: 1px solid #e17055;
        color: #2d3436;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: 500;
    }
    
    .stock-low {
        background: linear-gradient(135deg, #fab1a0, #e17055);
        color: white;
    }
    
    .stock-critical {
        background: linear-gradient(135deg, #ff7675, #d63031);
        color: white;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
    }
`;
document.head.appendChild(style);

// Modal para agregar nuevos registros
const addModal = document.createElement('div');
addModal.id = 'addModal';
addModal.className = 'modal';
addModal.innerHTML = `
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> Agregar Nuevo Registro</h2>
            <span class="close" onclick="closeModal('addModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addForm">
                <div id="formFields"></div>
                <div class="inventory-alerts" id="inventoryAlerts"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeModal('addModal')">Cancelar</button>
            <button type="button" class="btn-primary" onclick="saveNewRecord()">Guardar</button>
        </div>
    </div>
`;
document.body.appendChild(addModal);

// Modal para reporte de inventario
const reportModal = document.createElement('div');
reportModal.id = 'reportModal';
reportModal.className = 'modal';
reportModal.innerHTML = `
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h2><i class="fas fa-chart-bar"></i> Reporte de Inventario Integrado</h2>
            <span class="close" onclick="closeModal('reportModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div id="inventoryReport"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeModal('reportModal')">Cerrar</button>
            <button type="button" class="btn-info" onclick="exportReport()">Exportar PDF</button>
        </div>
    </div>
`;
document.body.appendChild(reportModal);

// Sistema de inventario integrado
const inventorySystem = {
    products: [
        { id: 1, name: 'Laptop HP', stock: 15, minStock: 5, price: 850000, category: 'Equipos' },
        { id: 2, name: 'Mouse Logitech', stock: 3, minStock: 10, price: 45000, category: 'Accesorios' },
        { id: 3, name: 'Teclado Mecánico', stock: 0, minStock: 5, price: 120000, category: 'Accesorios' },
        { id: 4, name: 'Monitor 24"', stock: 8, minStock: 3, price: 320000, category: 'Equipos' },
        { id: 5, name: 'Impresora Epson', stock: 2, minStock: 2, price: 180000, category: 'Equipos' }
    ],
    
    sales: [
        { id: 1, productId: 1, quantity: 2, date: '2025-09-28', customer: 'Juan Pérez', total: 1700000 },
        { id: 2, productId: 2, quantity: 5, date: '2025-09-29', customer: 'María García', total: 225000 },
        { id: 3, productId: 4, quantity: 1, date: '2025-09-30', customer: 'Carlos López', total: 320000 }
    ],
    
    purchases: [
        { id: 1, productId: 1, quantity: 20, date: '2025-09-25', supplier: 'TechnoPC', cost: 15000000 },
        { id: 2, productId: 2, quantity: 50, date: '2025-09-26', supplier: 'Accesorios Ltd', cost: 2000000 },
        { id: 3, productId: 4, quantity: 10, date: '2025-09-27', supplier: 'Monitor Solutions', cost: 2800000 }
    ],

    // Actualizar stock cuando se hace una compra
    processPurchase: function(productId, quantity) {
        const product = this.products.find(p => p.id === productId);
        if (product) {
            product.stock += quantity;
            this.checkStockAlerts();
            return true;
        }
        return false;
    },

    // Actualizar stock cuando se hace una venta
    processSale: function(productId, quantity) {
        const product = this.products.find(p => p.id === productId);
        if (product && product.stock >= quantity) {
            product.stock -= quantity;
            this.checkStockAlerts();
            return true;
        }
        return false;
    },

    // Verificar alertas de stock
    checkStockAlerts: function() {
        const alerts = [];
        this.products.forEach(product => {
            if (product.stock === 0) {
                alerts.push({
                    type: 'critical',
                    message: \`⚠️ CRÍTICO: \${product.name} está AGOTADO\`,
                    product: product
                });
            } else if (product.stock <= product.minStock) {
                alerts.push({
                    type: 'low',
                    message: \`📉 BAJO: \${product.name} tiene solo \${product.stock} unidades (mín: \${product.minStock})\`,
                    product: product
                });
            }
        });
        return alerts;
    },

    // Generar reporte completo
    generateReport: function() {
        const totalProducts = this.products.length;
        const totalStock = this.products.reduce((sum, p) => sum + p.stock, 0);
        const totalSales = this.sales.reduce((sum, s) => sum + s.total, 0);
        const totalPurchases = this.purchases.reduce((sum, p) => sum + p.cost, 0);
        const alerts = this.checkStockAlerts();
        
        return {
            summary: {
                totalProducts,
                totalStock,
                totalSales,
                totalPurchases,
                profit: totalSales - totalPurchases,
                alertsCount: alerts.length
            },
            alerts,
            products: this.products,
            topSelling: this.getTopSellingProducts(),
            lowStock: this.products.filter(p => p.stock <= p.minStock)
        };
    },

    getTopSellingProducts: function() {
        const salesByProduct = {};
        this.sales.forEach(sale => {
            salesByProduct[sale.productId] = (salesByProduct[sale.productId] || 0) + sale.quantity;
        });
        
        return Object.entries(salesByProduct)
            .map(([productId, quantity]) => ({
                product: this.products.find(p => p.id == productId),
                soldQuantity: quantity
            }))
            .filter(item => item.product)
            .sort((a, b) => b.soldQuantity - a.soldQuantity)
            .slice(0, 5);
    }
};

// Funciones para mostrar modales
function showAddForm() {
    const currentModule = window.location.pathname;
    const formFields = document.getElementById('formFields');
    
    let fields = '';
    
    if (currentModule.includes('productos') || currentModule.includes('gestion-productos')) {
        fields = \`
            <div class="form-group">
                <label>Nombre del Producto</label>
                <input type="text" class="form-control" id="productName" required>
            </div>
            <div class="form-group">
                <label>Categoría</label>
                <select class="form-control" id="category" required>
                    <option value="">Seleccionar...</option>
                    <option value="Equipos">Equipos</option>
                    <option value="Accesorios">Accesorios</option>
                    <option value="Software">Software</option>
                    <option value="Componentes">Componentes</option>
                </select>
            </div>
            <div class="form-group">
                <label>Precio</label>
                <input type="number" class="form-control" id="price" required>
            </div>
            <div class="form-group">
                <label>Stock Inicial</label>
                <input type="number" class="form-control" id="stock" required>
            </div>
            <div class="form-group">
                <label>Stock Mínimo</label>
                <input type="number" class="form-control" id="minStock" required>
            </div>
        \`;
    } else if (currentModule.includes('ventas') || currentModule.includes('gestion-ventas')) {
        fields = \`
            <div class="form-group">
                <label>Producto</label>
                <select class="form-control" id="productSelect" required onchange="updateProductInfo()">
                    <option value="">Seleccionar producto...</option>
                    \${inventorySystem.products.map(p => 
                        \`<option value="\${p.id}" data-stock="\${p.stock}" data-price="\${p.price}">
                            \${p.name} (Stock: \${p.stock})
                        </option>\`
                    ).join('')}
                </select>
            </div>
            <div class="form-group">
                <label>Cliente</label>
                <input type="text" class="form-control" id="customer" required>
            </div>
            <div class="form-group">
                <label>Cantidad</label>
                <input type="number" class="form-control" id="quantity" min="1" required onchange="calculateTotal()">
            </div>
            <div class="form-group">
                <label>Precio Unitario</label>
                <input type="number" class="form-control" id="unitPrice" readonly>
            </div>
            <div class="form-group">
                <label>Total</label>
                <input type="number" class="form-control" id="total" readonly>
            </div>
        \`;
    } else if (currentModule.includes('compras') || currentModule.includes('gestion-compras')) {
        fields = \`
            <div class="form-group">
                <label>Producto</label>
                <select class="form-control" id="productSelect" required>
                    <option value="">Seleccionar producto...</option>
                    \${inventorySystem.products.map(p => 
                        \`<option value="\${p.id}">\${p.name} (Stock actual: \${p.stock})</option>\`
                    ).join('')}
                </select>
            </div>
            <div class="form-group">
                <label>Proveedor</label>
                <input type="text" class="form-control" id="supplier" required>
            </div>
            <div class="form-group">
                <label>Cantidad</label>
                <input type="number" class="form-control" id="quantity" min="1" required>
            </div>
            <div class="form-group">
                <label>Costo Total</label>
                <input type="number" class="form-control" id="cost" required>
            </div>
        \`;
    } else {
        // Formulario genérico para otros módulos
        fields = \`
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" class="form-control" id="name" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" class="form-control" id="email">
            </div>
            <div class="form-group">
                <label>Teléfono</label>
                <input type="tel" class="form-control" id="phone">
            </div>
            <div class="form-group">
                <label>Dirección</label>
                <textarea class="form-control" id="address" rows="3"></textarea>
            </div>
        \`;
    }
    
    formFields.innerHTML = fields;
    
    // Mostrar alertas de inventario
    const alerts = inventorySystem.checkStockAlerts();
    const alertsContainer = document.getElementById('inventoryAlerts');
    if (alerts.length > 0) {
        alertsContainer.innerHTML = alerts.map(alert => 
            \`<div class="inventory-alert \${alert.type === 'critical' ? 'stock-critical' : 'stock-low'}">
                \${alert.message}
            </div>\`
        ).join('');
    }
    
    document.getElementById('addModal').style.display = 'flex';
}

function updateProductInfo() {
    const select = document.getElementById('productSelect');
    const option = select.options[select.selectedIndex];
    
    if (option.value) {
        const stock = option.getAttribute('data-stock');
        const price = option.getAttribute('data-price');
        
        document.getElementById('unitPrice').value = price;
        document.getElementById('quantity').setAttribute('max', stock);
        
        if (stock == 0) {
            alert('⚠️ Este producto está AGOTADO. No se puede vender.');
            select.value = '';
            return;
        }
        
        calculateTotal();
    }
}

function calculateTotal() {
    const quantity = document.getElementById('quantity')?.value || 0;
    const unitPrice = document.getElementById('unitPrice')?.value || 0;
    const total = quantity * unitPrice;
    
    if (document.getElementById('total')) {
        document.getElementById('total').value = total;
    }
}

function saveNewRecord() {
    const currentModule = window.location.pathname;
    
    if (currentModule.includes('productos') || currentModule.includes('gestion-productos')) {
        // Agregar producto
        const newProduct = {
            id: inventorySystem.products.length + 1,
            name: document.getElementById('productName').value,
            category: document.getElementById('category').value,
            price: parseInt(document.getElementById('price').value),
            stock: parseInt(document.getElementById('stock').value),
            minStock: parseInt(document.getElementById('minStock').value)
        };
        
        inventorySystem.products.push(newProduct);
        showSuccessMessage('✅ Producto agregado al inventario exitosamente');
        
    } else if (currentModule.includes('ventas') || currentModule.includes('gestion-ventas')) {
        // Procesar venta
        const productId = parseInt(document.getElementById('productSelect').value);
        const quantity = parseInt(document.getElementById('quantity').value);
        const customer = document.getElementById('customer').value;
        const total = parseInt(document.getElementById('total').value);
        
        if (inventorySystem.processSale(productId, quantity)) {
            const newSale = {
                id: inventorySystem.sales.length + 1,
                productId,
                quantity,
                customer,
                total,
                date: new Date().toISOString().split('T')[0]
            };
            
            inventorySystem.sales.push(newSale);
            showSuccessMessage(\`✅ Venta registrada. Stock actualizado automáticamente.\`);
            
            // Verificar alertas después de la venta
            const alerts = inventorySystem.checkStockAlerts();
            if (alerts.length > 0) {
                setTimeout(() => {
                    alerts.forEach(alert => showWarningMessage(alert.message));
                }, 1000);
            }
        } else {
            showErrorMessage('❌ Error: Stock insuficiente para esta venta');
            return;
        }
        
    } else if (currentModule.includes('compras') || currentModule.includes('gestion-compras')) {
        // Procesar compra
        const productId = parseInt(document.getElementById('productSelect').value);
        const quantity = parseInt(document.getElementById('quantity').value);
        const supplier = document.getElementById('supplier').value;
        const cost = parseInt(document.getElementById('cost').value);
        
        inventorySystem.processPurchase(productId, quantity);
        
        const newPurchase = {
            id: inventorySystem.purchases.length + 1,
            productId,
            quantity,
            supplier,
            cost,
            date: new Date().toISOString().split('T')[0]
        };
        
        inventorySystem.purchases.push(newPurchase);
        showSuccessMessage(\`✅ Compra registrada. Stock aumentado en \${quantity} unidades.\`);
    }
    
    // Actualizar la tabla (simular)
    setTimeout(() => {
        location.reload();
    }, 2000);
    
    closeModal('addModal');
}

function showInventoryReport() {
    const report = inventorySystem.generateReport();
    const reportContainer = document.getElementById('inventoryReport');
    
    reportContainer.innerHTML = \`
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-number">\${report.summary.totalProducts}</div>
                <div class="stat-label">Productos Registrados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">\${report.summary.totalStock}</div>
                <div class="stat-label">Unidades en Stock</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">$\${report.summary.totalSales.toLocaleString()}</div>
                <div class="stat-label">Ventas Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">$\${report.summary.profit.toLocaleString()}</div>
                <div class="stat-label">Ganancia</div>
            </div>
        </div>
        
        \${report.alerts.length > 0 ? \`
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #856404; margin-bottom: 15px;">🚨 Alertas de Inventario (\${report.alerts.length})</h3>
            \${report.alerts.map(alert => \`
                <div class="inventory-alert \${alert.type === 'critical' ? 'stock-critical' : 'stock-low'}">
                    \${alert.message}
                </div>
            \`).join('')}
        </div>
        \` : ''}
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div>
                <h3>🔥 Productos Más Vendidos</h3>
                <div style="background: var(--bg-primary); padding: 20px; border-radius: 10px;">
                    \${report.topSelling.map((item, index) => \`
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <span>#\${index + 1} \${item.product.name}</span>
                            <span style="font-weight: bold; color: var(--primary-color);">\${item.soldQuantity} vendidos</span>
                        </div>
                    \`).join('')}
                </div>
            </div>
            
            <div>
                <h3>📦 Estado Actual del Inventario</h3>
                <div style="background: var(--bg-primary); padding: 20px; border-radius: 10px;">
                    \${report.products.map(product => \`
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                            <div>
                                <div style="font-weight: bold;">\${product.name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">\${product.category}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: \${product.stock <= product.minStock ? '#dc3545' : '#28a745'};">
                                    Stock: \${product.stock}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    Min: \${product.minStock}
                                </div>
                            </div>
                        </div>
                    \`).join('')}
                </div>
            </div>
        </div>
    \`;
    
    document.getElementById('reportModal').style.display = 'flex';
}

function exportReport() {
    showSuccessMessage('📄 Reporte exportado a PDF (funcionalidad simulada)');
}

function showSuccessMessage(message) {
    const toast = document.createElement('div');
    toast.style.cssText = \`
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        z-index: 10000;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        animation: slideIn 0.3s ease;
    \`;
    toast.innerHTML = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 4000);
}

function showErrorMessage(message) {
    const toast = document.createElement('div');
    toast.style.cssText = \`
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        z-index: 10000;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        animation: slideIn 0.3s ease;
    \`;
    toast.innerHTML = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 4000);
}

function showWarningMessage(message) {
    const toast = document.createElement('div');
    toast.style.cssText = \`
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #ffc107, #ff8f00);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        z-index: 10000;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        animation: slideIn 0.3s ease;
    \`;
    toast.innerHTML = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 6000);
}

// Agregar animación CSS para toasts
const toastStyle = document.createElement('style');
toastStyle.textContent = \`
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
\`;
document.head.appendChild(toastStyle);

// Verificar alertas al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    const alerts = inventorySystem.checkStockAlerts();
    if (alerts.length > 0) {
        setTimeout(() => {
            showWarningMessage(\`⚠️ Hay \${alerts.length} alertas de inventario. Haz clic en "Reporte de Inventario" para ver detalles.\`);
        }, 2000);
    }
});
</script>

<!-- Sistema de Carrito JavaScript -->
<script src="{% static 'js/carrito-system.js' %}"></script>
{% endblock %}