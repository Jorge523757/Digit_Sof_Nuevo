{% extends 'main/gestion/base_gestion.html' %}

{% block header_icon %}<i class="fas fa-box"></i>{% endblock %}

{% block stats_section %}
<div class="stats-cards">
    <div class="stat-card">
        <div class="stat-number">{{ total_productos }}</div>
        <div class="stat-label">Total Productos</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ marcas|length }}</div>
        <div class="stat-label">Marcas Disponibles</div>
    </div>
</div>
{% endblock %}

{% block table_icon %}<i class="fas fa-box"></i>{% endblock %}
{% block table_title %}Inventario de Productos{% endblock %}

{% block table_content %}
{% if productos_data %}
<table class="data-table">
    <thead>
        <tr>
            <th>Imagen</th>
            <th>ID</th>
            <th>Producto</th>
            <th>Marca</th>
            <th>Stock</th>
            <th>Valor</th>
            <th>Compras</th>
            <th>Ventas</th>
            <th>Carrito</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for item in productos_data %}
        <tr data-id="{{ item.producto.id_producto }}">
            <td class="product-image-cell">
                <img src="/static/productos/imagenes/{% if item.producto.id_producto == 1 %}laptop-hp.svg{% elif item.producto.id_producto == 2 %}mouse-logitech.svg{% elif item.producto.id_producto == 3 %}teclado-mecanico.svg{% elif item.producto.id_producto == 4 %}monitor-24.svg{% elif item.producto.id_producto == 5 %}impresora-epson.svg{% else %}default-product.svg{% endif %}" 
                     alt="{{ item.producto.nombreProducto }}" 
                     class="product-image"
                     onerror="this.src='/static/productos/imagenes/default-product.svg'">
            </td>
            <td><strong>#{{ item.producto.id_producto }}</strong></td>
            <td>
                <strong>{{ item.producto.nombreProducto }}</strong>
                <br>
                <small class="text-muted">{{ item.producto.modelo_producto }}</small>
                {% if item.producto.diseño %}
                <br><small>{{ item.producto.diseño }}</small>
                {% endif %}
            </td>
            <td>{{ item.producto.marca.marca }}</td>
            <td>
                <span class="badge {% if item.stock_actual < 10 %}badge-warning{% else %}badge-success{% endif %}">
                    {{ item.stock_actual }} unidades
                </span>
            </td>
            <td>${{ item.producto.valor_producto }}</td>
            <td>
                <span class="badge badge-info">{{ item.compras_count }} compras</span>
                {% if item.compras %}
                <div class="related-data">
                    <strong>Últimas compras:</strong>
                    {% for compra in item.compras %}
                    <div class="related-item">
                        <span>{{ compra.cantidad_comprada }} und.</span>
                        <span>{{ compra.fecha_compra }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </td>
            <td>
                <span class="badge badge-primary">{{ item.ventas_count }} ventas</span>
                {% if item.ventas %}
                <div class="related-data">
                    <strong>Últimas ventas:</strong>
                    {% for venta in item.ventas %}
                    <div class="related-item">
                        <span>{{ venta.cantidad_vendidas }} und.</span>
                        <span>${{ venta.valor_venta }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </td>
            <td class="cart-actions">
                <div class="cart-section">
                    {% if item.stock_actual > 0 %}
                    <div class="add-to-cart">
                        <input type="number" 
                               class="cart-quantity-input" 
                               id="qty-{{ item.producto.id_producto }}"
                               min="1" 
                               max="{{ item.stock_actual }}" 
                               value="1">
                        <button class="btn-cart" 
                                onclick="addProductToCart({{ item.producto.id_producto }})"
                                title="Agregar al carrito">
                            <i class="fas fa-cart-plus"></i>
                        </button>
                    </div>
                    <div class="cart-quick-actions">
                        <button class="btn-quick" 
                                onclick="quickAddToCart({{ item.producto.id_producto }}, 1)"
                                title="Agregar 1 unidad">
                            +1
                        </button>
                        {% if item.stock_actual >= 5 %}
                        <button class="btn-quick" 
                                onclick="quickAddToCart({{ item.producto.id_producto }}, 5)"
                                title="Agregar 5 unidades">
                            +5
                        </button>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="out-of-stock">
                        <span class="stock-alert">AGOTADO</span>
                        <button class="btn-notify" onclick="notifyRestock({{ item.producto.id_producto }})" title="Notificar cuando esté disponible">
                            <i class="fas fa-bell"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </td>
            <td>
                <div class="action-buttons">
                    <button class="btn-sm btn-primary" onclick="viewDetails('{{ item.producto.id_producto }}', 'producto')" title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-sm btn-warning" onclick="editRecord('{{ item.producto.id_producto }}', 'producto')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-sm btn-danger" onclick="deleteRecord('{{ item.producto.id_producto }}', 'producto')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% if item.producto.stock_actual < 10 %}
                    <button class="btn-sm btn-success" onclick="restockProduct('{{ item.producto.id_producto }}')" title="Reabastecer">
                        <i class="fas fa-plus"></i>
                    </button>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <i class="fas fa-box"></i>
    <h3>No hay productos registrados</h3>
    <p>Comienza agregando productos al inventario.</p>
    <button class="btn-sm btn-primary">
        <i class="fas fa-plus"></i> Agregar Producto
    </button>
</div>
{% endif %}
{% endblock %}

{% block pagination %}
{% if productos_data.has_other_pages %}
<div class="pagination-container">
    <ul class="pagination">
        {% if productos_data.has_previous %}
            <li><a href="?page=1">&laquo; Primera</a></li>
            <li><a href="?page={{ productos_data.previous_page_number }}">Anterior</a></li>
        {% endif %}
        
        {% for num in productos_data.paginator.page_range %}
            {% if productos_data.number == num %}
                <li class="current">{{ num }}</li>
            {% elif num > productos_data.number|add:'-3' and num < productos_data.number|add:'3' %}
                <li><a href="?page={{ num }}">{{ num }}</a></li>
            {% endif %}
        {% endfor %}
        
        {% if productos_data.has_next %}
            <li><a href="?page={{ productos_data.next_page_number }}">Siguiente</a></li>
            <li><a href="?page={{ productos_data.paginator.num_pages }}">Última &raquo;</a></li>
        {% endif %}
    </ul>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
// Datos de productos con sus imágenes
const productsData = {
    1: { name: 'Laptop HP', price: 850000, image: '/static/productos/imagenes/laptop-hp.svg' },
    2: { name: 'Mouse Logitech', price: 45000, image: '/static/productos/imagenes/mouse-logitech.svg' },
    3: { name: 'Teclado Mecánico RGB', price: 120000, image: '/static/productos/imagenes/teclado-mecanico.svg' },
    4: { name: 'Monitor 24" Full HD', price: 320000, image: '/static/productos/imagenes/monitor-24.svg' },
    5: { name: 'Impresora Epson', price: 180000, image: '/static/productos/imagenes/impresora-epson.svg' }
};

// Función para agregar producto al carrito
function addProductToCart(productId) {
    const quantityInput = document.getElementById(`qty-${productId}`);
    const quantity = parseInt(quantityInput.value) || 1;
    
    if (quantity <= 0) {
        showErrorToast('❌ Cantidad debe ser mayor a 0');
        return;
    }
    
    // Verificar stock disponible
    const row = document.querySelector(`tr[data-id="${productId}"]`);
    const stockElement = row.querySelector('.badge');
    const stockText = stockElement.textContent;
    const availableStock = parseInt(stockText.match(/\\d+/)[0]);
    
    if (quantity > availableStock) {
        showErrorToast(`❌ Stock insuficiente. Disponible: ${availableStock}`);
        return;
    }
    
    // Agregar al carrito (usar localStorage para persistencia)
    let cart = JSON.parse(localStorage.getItem('digitSoftCart') || '{"items": [], "discount": 0}');
    
    const product = productsData[productId];
    if (!product) {
        showErrorToast('❌ Producto no encontrado');
        return;
    }
    
    // Buscar si el producto ya está en el carrito
    const existingItem = cart.items.find(item => item.id === productId);
    
    if (existingItem) {
        const newQuantity = existingItem.quantity + quantity;
        if (newQuantity > availableStock) {
            showErrorToast(`❌ No puedes agregar más. Total máximo: ${availableStock}`);
            return;
        }
        existingItem.quantity = newQuantity;
    } else {
        cart.items.push({
            id: productId,
            name: product.name,
            price: product.price,
            image: product.image,
            quantity: quantity,
            category: 'Equipos',
            description: `${product.name} - Producto de alta calidad`
        });
    }
    
    // Guardar carrito actualizado
    localStorage.setItem('digitSoftCart', JSON.stringify(cart));
    
    // Mostrar confirmación con opción de ir al carrito
    showCartSuccessToast(product.name, quantity);
    
    // Resetear cantidad
    quantityInput.value = 1;
    
    // Actualizar contador del carrito si existe
    updateCartCounter();
}

// Función para agregar rápidamente al carrito
function quickAddToCart(productId, quantity) {
    const quantityInput = document.getElementById(`qty-${productId}`);
    quantityInput.value = quantity;
    addProductToCart(productId);
}

// Función para notificar cuando esté en stock
function notifyRestock(productId) {
    const product = productsData[productId];
    const notifications = JSON.parse(localStorage.getItem('restockNotifications') || '[]');
    
    if (!notifications.includes(productId)) {
        notifications.push(productId);
        localStorage.setItem('restockNotifications', JSON.stringify(notifications));
        showSuccessToast(`🔔 Te notificaremos cuando ${product.name} esté disponible`);
    } else {
        showInfoToast(`ℹ️ Ya estás suscrito a notificaciones de ${product.name}`);
    }
}

// Función para mostrar toast de éxito con enlace al carrito
function showCartSuccessToast(productName, quantity) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 20px 25px;
        border-radius: 12px;
        z-index: 10000;
        font-weight: 600;
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        animation: slideInRight 0.4s ease;
        max-width: 350px;
        cursor: pointer;
    `;
    
    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-cart-plus" style="font-size: 1.5rem;"></i>
            <div>
                <div>✅ ${productName}</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">${quantity} unidad${quantity > 1 ? 'es' : ''} agregada${quantity > 1 ? 's' : ''} al carrito</div>
                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">
                    🖱️ Haz clic para ir al carrito
                </div>
            </div>
        </div>
    `;
    
    toast.onclick = function() {
        window.location.href = '/carrito/';
    };
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Función para actualizar contador del carrito
function updateCartCounter() {
    const cart = JSON.parse(localStorage.getItem('digitSoftCart') || '{"items": []}');
    const totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
    
    // Buscar y actualizar cualquier contador de carrito en la página
    const counters = document.querySelectorAll('.cart-counter, #cartItemsCount');
    counters.forEach(counter => {
        counter.textContent = totalItems;
    });
    
    // Crear notificación flotante del carrito si no existe
    let cartFloat = document.getElementById('cartFloat');
    if (!cartFloat && totalItems > 0) {
        cartFloat = document.createElement('div');
        cartFloat.id = 'cartFloat';
        cartFloat.innerHTML = `
            <a href="/carrito/" style="color: white; text-decoration: none;">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-badge">${totalItems}</span>
            </a>
        `;
        cartFloat.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        `;
        document.body.appendChild(cartFloat);
        
        cartFloat.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1)';
        });
        
        cartFloat.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    } else if (cartFloat) {
        const badge = cartFloat.querySelector('.cart-badge');
        if (badge) {
            badge.textContent = totalItems;
        }
        
        if (totalItems === 0) {
            cartFloat.remove();
        }
    }
}

// Funciones de notificación
function showSuccessToast(message) {
    createToast(message, 'success');
}

function showErrorToast(message) {
    createToast(message, 'error');
}

function showInfoToast(message) {
    createToast(message, 'info');
}

function createToast(message, type) {
    const toast = document.createElement('div');
    const colors = {
        success: 'linear-gradient(135deg, #28a745, #20c997)',
        error: 'linear-gradient(135deg, #dc3545, #c82333)',
        info: 'linear-gradient(135deg, #17a2b8, #007bff)'
    };
    
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type]};
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        z-index: 10000;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        animation: slideInRight 0.3s ease;
    `;
    toast.innerHTML = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 4000);
}

// Inicializar contador al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    updateCartCounter();
});

// Agregar estilos CSS para las nuevas funcionalidades
const productCartStyles = document.createElement('style');
productCartStyles.textContent = `
    .product-image-cell {
        text-align: center;
        padding: 10px;
    }
    
    .product-image {
        width: 60px;
        height: 45px;
        object-fit: contain;
        border-radius: 8px;
        border: 2px solid var(--border-color);
        background: white;
        padding: 3px;
        transition: all 0.3s ease;
    }
    
    .product-image:hover {
        transform: scale(1.2);
        border-color: var(--primary-color);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }
    
    .cart-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
    }
    
    .add-to-cart {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .cart-quantity-input {
        width: 50px;
        padding: 4px;
        border: 2px solid var(--border-color);
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
        background: var(--bg-primary);
        color: var(--text-primary);
    }
    
    .cart-quantity-input:focus {
        border-color: var(--primary-color);
        outline: none;
    }
    
    .btn-cart {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .btn-cart:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }
    
    .cart-quick-actions {
        display: flex;
        gap: 4px;
    }
    
    .btn-quick {
        background: linear-gradient(135deg, #17a2b8, #007bff);
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    .btn-quick:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
    }
    
    .out-of-stock {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }
    
    .stock-alert {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        animation: pulse 2s infinite;
    }
    
    .btn-notify {
        background: linear-gradient(135deg, #ffc107, #ff8f00);
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-notify:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(255, 193, 7, 0.4);
    }
    
    .cart-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #dc3545;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
`;
document.head.appendChild(productCartStyles);
</script>
{% endblock %}