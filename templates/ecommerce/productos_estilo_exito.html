{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - DIGITSOFT E-commerce</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="{% static 'css/productos-exito.css' %}">
</head>
<body>
    <!-- Header fijo amarillo estilo √âxito -->
    <header class="exito-header">
        <div class="container-fluid">
            <div class="row align-items-center py-2">
                <div class="col-md-2">
                    <a href="{% url 'core:landing' %}" class="logo">
                        <strong style="font-size: 2rem;">digit</strong>
                        <strong style="font-size: 1.2rem; vertical-align: super;">soft</strong>
                    </a>
                </div>
                <div class="col-md-1">
                    <button class="btn-menu" id="btnMenu">
                        <i class="fas fa-bars"></i>
                        <span>Men√∫</span>
                    </button>
                </div>
                <div class="col-md-6">
                    <form class="search-bar" method="GET">
                        <input type="text" name="q" class="search-input"
                               placeholder="Buscar en DIGITSOFT"
                               value="{{ request.GET.q|default:'' }}">
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>
                <div class="col-md-3 text-end">
                    <div class="header-actions">
                        {% if user.is_authenticated %}
                        <!-- Bot√≥n de notificaciones -->
                        <button class="header-btn" id="btnNotifications">
                            <i class="fas fa-bell"></i>
                            <span class="d-none d-md-inline">Notificaciones</span>
                        </button>

                        <!-- Bot√≥n Mi Cuenta -->
                        <button class="header-btn" id="btnAccount">
                            <i class="fas fa-user-circle"></i>
                            <span class="d-none d-md-inline">Mi Cuenta</span>
                        </button>

                        <!-- Bot√≥n Carrito -->
                        <button class="header-btn btn-cart" id="btnCarrito">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="d-none d-md-inline">Carrito</span>
                            <span class="cart-badge" id="cartBadge">0</span>
                        </button>
                        {% else %}
                        <a href="{% url 'usuarios:login' %}" class="btn btn-login">
                            <i class="fas fa-sign-in-alt"></i> Ingresar
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navegaci√≥n secundaria -->
    <nav class="secondary-nav">
        <div class="container-fluid">
            <ul class="nav-items">
                <li><a href="{% url 'core:landing' %}">Inicio</a></li>
                <li><a href="#" class="active">Inicio</a></li>
                <li><a href="#">Ofertas y promociones</a></li>
                <li><a href="#">Disfruta env√≠o gratis</a></li>
                <li><a href="#">Vende con nosotros</a></li>
            </ul>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="main-content">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar de filtros -->
                <aside class="col-lg-3 col-md-4 filters-sidebar" id="filtersSidebar">
                    <div class="filters-header">
                        <h5><i class="fas fa-filter"></i> Filtrado por</h5>
                        <button class="btn-clear-filters" id="btnClearFilters">
                            <i class="fas fa-times-circle"></i> Limpiar filtros
                        </button>
                    </div>

                    <!-- Departamento -->
                    <div class="filter-section">
                        <button class="filter-title" data-toggle="collapse" data-target="#departmentCollapse">
                            Departamento
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="filter-content collapse show" id="departmentCollapse">
                            <label class="filter-option">
                                <input type="checkbox" name="department" value="tecnologia">
                                <span>Tecnolog√≠a</span>
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" name="department" value="moda">
                                <span>Moda y accesorios</span>
                            </label>
                        </div>
                    </div>

                    <!-- Categor√≠a -->
                    <div class="filter-section">
                        <button class="filter-title" data-toggle="collapse" data-target="#categoryCollapse">
                            Categor√≠a
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="filter-content collapse show" id="categoryCollapse">
                            {% for categoria in categorias %}
                            <label class="filter-option">
                                <input type="checkbox" name="category" value="{{ categoria.id }}"
                                       {% if categoria.id|stringformat:"s" in categorias_seleccionadas %}checked{% endif %}>
                                <span>{{ categoria.nombre }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Marca -->
                    <div class="filter-section">
                        <button class="filter-title" data-toggle="collapse" data-target="#brandCollapse">
                            Marca
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="filter-content collapse show" id="brandCollapse">
                            {% for marca in marcas %}
                            <label class="filter-option">
                                <input type="checkbox" name="brand" value="{{ marca }}">
                                <span>{{ marca }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Precio -->
                    <div class="filter-section">
                        <button class="filter-title" data-toggle="collapse" data-target="#priceCollapse">
                            Precio
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="filter-content collapse show" id="priceCollapse">
                            <label class="filter-option">
                                <input type="radio" name="price" value="0-500000">
                                <span>Menos de $500.000</span>
                            </label>
                            <label class="filter-option">
                                <input type="radio" name="price" value="500000-1000000">
                                <span>$500.000 - $1.000.000</span>
                            </label>
                            <label class="filter-option">
                                <input type="radio" name="price" value="1000000-2000000">
                                <span>$1.000.000 - $2.000.000</span>
                            </label>
                            <label class="filter-option">
                                <input type="radio" name="price" value="2000000-">
                                <span>M√°s de $2.000.000</span>
                            </label>
                        </div>
                    </div>

                    <!-- Colores (ejemplo) -->
                    <div class="filter-section">
                        <button class="filter-title" data-toggle="collapse" data-target="#colorCollapse">
                            Colores
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="filter-content collapse show" id="colorCollapse">
                            <div class="color-filters">
                                <label class="color-option" title="Negro">
                                    <input type="checkbox" name="color" value="negro">
                                    <span class="color-swatch" style="background: #000;"></span>
                                </label>
                                <label class="color-option" title="Azul">
                                    <input type="checkbox" name="color" value="azul">
                                    <span class="color-swatch" style="background: #1e40af;"></span>
                                </label>
                                <label class="color-option" title="Rojo">
                                    <input type="checkbox" name="color" value="rojo">
                                    <span class="color-swatch" style="background: #dc2626;"></span>
                                </label>
                                <label class="color-option" title="Verde">
                                    <input type="checkbox" name="color" value="verde">
                                    <span class="color-swatch" style="background: #16a34a;"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- √Årea de productos -->
                <main class="col-lg-9 col-md-8 products-area">
                    <!-- Barra de resultados y ordenamiento -->
                    <div class="results-bar">
                        <div class="results-info">
                            <button class="btn-toggle-filters d-md-none" id="btnToggleFilters">
                                <i class="fas fa-filter"></i>
                            </button>
                            <span class="results-count">{{ productos|length }} resultados</span>
                        </div>
                        <div class="results-controls">
                            <span class="me-2">Ordenar por:</span>
                            <select class="form-select form-select-sm" id="sortSelect" style="width: auto;">
                                <option value="relevance">Relevancia</option>
                                <option value="price_asc">Precio: Menor a Mayor</option>
                                <option value="price_desc">Precio: Mayor a Menor</option>
                                <option value="newest">M√°s Nuevos</option>
                            </select>
                            <div class="view-toggle ms-3">
                                <span>Vista:</span>
                                <button class="view-btn active" data-view="grid">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button class="view-btn" data-view="list">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Grid de productos -->
                    <div class="products-grid" id="productsGrid">
                        {% for producto in productos %}
                        <article class="product-card-exito" data-id="{{ producto.id }}">
                            <!-- Badges -->
                            {% if producto.destacado %}
                            <div class="product-badge badge-featured">
                                <i class="fas fa-star"></i> Destacado
                            </div>
                            {% endif %}
                            {% if producto.precio_mayorista %}
                            <div class="product-badge badge-discount">
                                -{{ producto.descuento|default:"20" }}%
                            </div>
                            {% endif %}

                            <!-- Imagen -->
                            <div class="product-image-exito">
                                {% if producto.imagen %}
                                <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre_producto }}">
                                {% else %}
                                <div class="no-image">
                                    <i class="fas fa-laptop-code"></i>
                                </div>
                                {% endif %}
                                <button class="btn-wishlist" title="Agregar a favoritos">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>

                            <!-- Info -->
                            <div class="product-info-exito">
                                <!-- Categor√≠a/Marca -->
                                <span class="product-brand">{{ producto.marca|default:producto.categoria.nombre }}</span>

                                <!-- Nombre -->
                                <h3 class="product-title-exito">
                                    <a href="{% url 'ecommerce:producto_detalle' producto.id %}">
                                        {{ producto.nombre_producto }}
                                    </a>
                                </h3>

                                <!-- Precio -->
                                <div class="product-pricing">
                                    {% if producto.precio_mayorista %}
                                    <div class="price-discount">-{{ producto.descuento|default:"20" }}%</div>
                                    <div class="price-original">${{ producto.precio_venta|floatformat:0 }}</div>
                                    <div class="price-current">${{ producto.precio_mayorista|floatformat:0 }}</div>
                                    {% else %}
                                    <div class="price-current">${{ producto.precio_venta|floatformat:0 }}</div>
                                    {% endif %}
                                </div>

                                <!-- Vendido por -->
                                <p class="product-seller">
                                    <i class="fas fa-store"></i>
                                    Vendido por: <strong>Webcaster</strong>
                                </p>

                                <!-- Rating y opiniones -->
                                <div class="product-rating">
                                    <span class="rating-stars">
                                        <i class="fas fa-star"></i>
                                        5.0
                                    </span>
                                    <span class="rating-count">(1 opiniones)</span>
                                </div>

                                <!-- Ofertas adicionales -->
                                {% if producto.precio_mayorista %}
                                <div class="product-offers">
                                    <p><i class="fas fa-tag"></i> Ver 8 ofertas adicionales</p>
                                </div>
                                {% endif %}

                                <!-- Bot√≥n agregar -->
                                <button class="btn-add-exito btn-add-to-cart"
                                        data-producto-id="{{ producto.id }}"
                                        data-nombre="{{ producto.nombre_producto }}"
                                        data-precio="{{ producto.precio_venta }}"
                                        data-stock="{{ producto.stock_actual }}"
                                        data-categoria="{{ producto.categoria.nombre }}"
                                        data-imagen="{{ producto.imagen.url|default:'' }}">
                                    <i class="fas fa-cart-plus"></i>
                                    Agregar
                                </button>
                            </div>
                        </article>
                        {% empty %}
                        <div class="no-results">
                            <i class="fas fa-search" style="font-size: 3rem; color: #ccc;"></i>
                            <h3>No se encontraron productos</h3>
                            <p>Intenta con otros filtros o busca algo diferente</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Paginaci√≥n -->
                    {% if productos %}
                    <nav class="pagination-nav">
                        <ul class="pagination">
                            <li class="page-item disabled">
                                <a class="page-link" href="#">Anterior</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Siguiente</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </main>
            </div>
        </div>
    </div>

    <!-- Drawer del Carrito (slide-in desde la derecha) -->
    <div class="cart-drawer" id="cartDrawer">
        <div class="cart-drawer-header">
            <h4><i class="fas fa-shopping-cart"></i> Agregados al carrito</h4>
            <button class="btn-close-drawer" id="btnCloseDrawer">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-drawer-alert">
            <i class="fas fa-info-circle"></i>
            Los descuentos ser√°n visualizados al seleccionar el m√©todo de pago
        </div>
        <div class="cart-drawer-body" id="cartDrawerBody">
            <!-- Items del carrito se insertan aqu√≠ din√°micamente -->
        </div>
        <div class="cart-drawer-footer">
            <div class="cart-subtotal">
                <span>Subtotal:</span>
                <strong id="cartSubtotal">$0</strong>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button id="btnVaciarCarrito" class="btn-empty-cart" style="flex: 1; padding: 12px; background: white; border: 2px solid #ef4444; color: #ef4444; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    <i class="fas fa-trash-alt"></i> Vaciar Carrito
                </button>
                <a href="{% url 'ecommerce:checkout' %}" class="btn-checkout-drawer" style="flex: 2;">
                    <i class="fas fa-credit-card"></i>
                    Ir a pagar
                </a>
            </div>
        </div>
    </div>

    <!-- Overlay oscuro para el drawer -->
    <div class="cart-overlay" id="cartOverlay"></div>

    <!-- Modal de confirmaci√≥n de eliminaci√≥n de producto individual -->
    <div class="delete-modal" id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 99999; align-items: center; justify-content: center;">
        <div class="delete-modal-content" style="background: white; border-radius: 20px; max-width: 480px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideDown 0.3s ease-out;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 20px; border-radius: 20px 20px 0 0; text-align: center;">
                <div style="background: white; width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; color: #ef4444;"></i>
                </div>
                <h3 style="color: #991b1b; font-weight: 700; font-size: 1.5rem; margin: 0;">¬øEliminar producto?</h3>
            </div>

            <!-- Producto info -->
            <div id="deleteProductInfo" style="padding: 25px; border-bottom: 2px dashed #e5e7eb;">
                <!-- Se llena din√°micamente -->
            </div>

            <!-- Mensaje -->
            <div style="padding: 20px 25px; text-align: center;">
                <p style="color: #6b7280; font-size: 0.95rem; margin: 0;">Esta acci√≥n remover√° el producto de tu carrito de compras</p>
            </div>

            <!-- Botones -->
            <div style="padding: 0 25px 25px; display: flex; gap: 12px;">
                <button id="btnCancelDelete" style="flex: 1; padding: 14px; border: 2px solid #e5e7eb; background: white; color: #6b7280; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button id="btnConfirmDelete" style="flex: 1; padding: 14px; border: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">
                    <i class="fas fa-trash"></i> S√≠, eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n para VACIAR carrito completo -->
    <div class="empty-cart-modal" id="emptyCartModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 99999; align-items: center; justify-content: center;">
        <div class="empty-cart-modal-content" style="background: white; border-radius: 20px; max-width: 520px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideDown 0.3s ease-out;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 25px; border-radius: 20px 20px 0 0; text-align: center;">
                <div style="background: white; width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
                    <i class="fas fa-shopping-cart" style="font-size: 2.8rem; color: #f59e0b;"></i>
                </div>
                <h3 style="color: #92400e; font-weight: 700; font-size: 1.6rem; margin: 0;">¬øVaciar Carrito Completo?</h3>
            </div>

            <!-- Resumen del carrito -->
            <div id="emptyCartSummary" style="padding: 25px;">
                <!-- Se llena din√°micamente -->
            </div>

            <!-- Mensaje de advertencia -->
            <div style="padding: 0 25px 20px; text-align: center;">
                <div style="background: #fef3c7; padding: 15px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                    <p style="color: #92400e; font-size: 0.95rem; margin: 0; font-weight: 600;">
                        <i class="fas fa-exclamation-circle"></i>
                        Esta acci√≥n eliminar√° TODOS los productos de tu carrito
                    </p>
                </div>
            </div>

            <!-- Botones -->
            <div style="padding: 0 25px 25px; display: flex; gap: 12px;">
                <button id="btnCancelEmptyCart" style="flex: 1; padding: 14px; border: 2px solid #e5e7eb; background: white; color: #6b7280; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button id="btnConfirmEmptyCart" style="flex: 1; padding: 14px; border: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
                    <i class="fas fa-trash-alt"></i> S√≠, vaciar todo
                </button>
            </div>
        </div>
    </div>

    <style>
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-30px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    #btnCancelDelete:hover, #btnCancelEmptyCart:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        transform: translateY(-2px);
    }

    #btnConfirmDelete:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    #btnConfirmEmptyCart:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
    }

    .btn-empty-cart:hover {
        background: #fef2f2 !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
    }

    .delete-modal, .empty-cart-modal {
        display: none !important;
    }

    .delete-modal.show, .empty-cart-modal.show {
        display: flex !important;
    }
    </style>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ‚ö° Script de im√°genes del carrito - DEBE CARGAR PRIMERO -->
    <script>
    <script>
    (function() {
        console.log('üöÄ Sistema de im√°genes del carrito v3.0 iniciado');

        // Normalizar URLs relativas a absolutas
        function normalizeUrl(url) {
            if (!url) return '';
            url = String(url).trim();
            if (url.startsWith('//')) return location.protocol + url;
            if (url.startsWith('/')) return location.origin + url;
            if (!url.startsWith('http')) return location.origin + '/' + url;
            return url;
        }

        // Obtener imagen desde tarjeta de producto
        function getImageFromCard(card) {
            if (!card) return '';
            const img = card.querySelector('.product-image-exito img');
            if (!img) return '';
            return img.src || img.getAttribute('data-src') || img.currentSrc || '';
        }

        // Construir mapa global de im√°genes
        function buildImageMap() {
            const map = {};
            document.querySelectorAll('.product-card-exito').forEach(card => {
                const id = card.dataset.id || (card.querySelector('.btn-add-exito') && card.querySelector('.btn-add-exito').dataset.productoId);
                const src = getImageFromCard(card);
                if (id && src) {
                    map[id] = normalizeUrl(src);
                    console.log(`üì∏ Imagen mapeada para producto ${id}:`, map[id]);
                }
            });
            return map;
        }

        let mapaImagenes = {};

        document.addEventListener('DOMContentLoaded', function() {
            // Construir mapa de im√°genes
            mapaImagenes = buildImageMap();
            console.log(`‚úÖ ${Object.keys(mapaImagenes).length} im√°genes de productos mapeadas`);

            // Interceptar clics en botones de agregar al carrito
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('.btn-add-exito, .btn-add-to-cart');
                if (!btn) return;

                // DETENER la propagaci√≥n para evitar conflictos con otros scripts
                e.stopPropagation();
                e.preventDefault();

                const card = btn.closest('.product-card-exito');
                const productoId = btn.dataset.productoId || btn.dataset.id || (card && card.dataset.id);

                if (!productoId) {
                    console.warn('‚ö†Ô∏è No se pudo obtener el ID del producto');
                    return;
                }

                const nombre = btn.dataset.nombre || btn.dataset.name || (card && card.querySelector('.product-title-exito a') && card.querySelector('.product-title-exito a').textContent.trim()) || 'Producto';
                const precio = btn.dataset.precio || btn.dataset.price || '0';

                // M√∫ltiples fuentes para obtener la imagen - MEJORADO
                let imagen = '';

                console.log('üîç DEBUG - Buscando imagen para producto:', productoId);

                // 1. Intentar desde data-imagen del bot√≥n (prioridad)
                imagen = btn.getAttribute('data-imagen') || btn.dataset.imagen || '';
                console.log('  1Ô∏è‚É£ data-imagen del bot√≥n:', imagen);

                // 2. Si est√° vac√≠o, buscar en otros atributos
                if (!imagen || imagen.trim() === '') {
                    imagen = btn.getAttribute('data-image') || btn.dataset.image || '';
                    console.log('  2Ô∏è‚É£ data-image del bot√≥n:', imagen);
                }

                // 3. Si a√∫n est√° vac√≠o, buscar en la tarjeta
                if (!imagen || imagen.trim() === '') {
                    const imgFromCard = getImageFromCard(card);
                    console.log('  3Ô∏è‚É£ imagen de la tarjeta:', imgFromCard);
                    imagen = imgFromCard || '';
                }

                // 4. √öltimo recurso: mapa global
                if (!imagen || imagen.trim() === '') {
                    console.log('  4Ô∏è‚É£ buscando en mapa global...', mapaImagenes[productoId]);
                    imagen = mapaImagenes[productoId] || '';
                }

                // 5. Normalizar URL
                const imagenOriginal = imagen;
                imagen = normalizeUrl(imagen);
                console.log('  5Ô∏è‚É£ URL normalizada:', imagenOriginal, '->', imagen);

                console.log(`üõí Agregando producto ${productoId}:`, {
                    nombre: nombre,
                    precio: precio,
                    imagen: imagen,
                    dataBtnImagen: btn.getAttribute('data-imagen'),
                    btnDataset: btn.dataset
                });

                // Obtener carrito actual
                const key = 'carrito_v1';
                const carrito = JSON.parse(localStorage.getItem(key) || '{}');

                // Agregar o actualizar producto
                if (!carrito[productoId]) {
                    carrito[productoId] = {
                        id: productoId,
                        name: nombre,
                        nombre: nombre,
                        price: precio,
                        precio: precio,
                        qty: 1,
                        cantidad: 1,
                        image: imagen,
                        imagen: imagen
                    };
                    console.log('‚úÖ Producto nuevo agregado al carrito');
                } else {
                    const currentQty = parseInt(carrito[productoId].qty || carrito[productoId].cantidad || 0, 10);
                    carrito[productoId].qty = currentQty + 1;
                    carrito[productoId].cantidad = carrito[productoId].qty;

                    // Actualizar imagen si estaba vac√≠a
                    if (!carrito[productoId].image && imagen) {
                        carrito[productoId].image = imagen;
                        carrito[productoId].imagen = imagen;
                        console.log('‚úÖ Imagen actualizada en producto existente');
                    }
                    console.log(`‚úÖ Cantidad actualizada a ${carrito[productoId].qty}`);
                }

                // Guardar carrito
                localStorage.setItem(key, JSON.stringify(carrito));

                // Actualizar UI
                if (typeof window.renderCartItems === 'function') window.renderCartItems();
                if (typeof updateCartBadge === 'function') updateCartBadge();
            });

            // Sobrescribir funci√≥n de renderizado del carrito
            window.renderCartItems = function() {
                const carrito = JSON.parse(localStorage.getItem('carrito_v1') || '{}');
                const items = Object.values(carrito);
                const cartDrawerBody = document.getElementById('cartDrawerBody');
                const cartSubtotal = document.getElementById('cartSubtotal');

                if (!cartDrawerBody) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ el contenedor del carrito');
                    return;
                }

                if (items.length === 0) {
                    cartDrawerBody.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                            <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 16px;"></i>
                            <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">Tu carrito est√° vac√≠o</p>
                            <p style="font-size: 0.9rem;">¬°Agrega productos incre√≠bles!</p>
                        </div>
                    `;
                    if (cartSubtotal) cartSubtotal.textContent = '$0';
                    return;
                }

                let html = '';
                let subtotal = 0;

                items.forEach(item => {
                    const precio = parseFloat(item.price || item.precio || 0) || 0;
                    const cantidad = parseInt(item.qty || item.cantidad || 1, 10) || 1;
                    subtotal += precio * cantidad;

                    // M√∫ltiples fuentes para la imagen
                    let imagenSrc = item.image || item.imagen || mapaImagenes[item.id] || '';
                    imagenSrc = normalizeUrl(imagenSrc);

                    const tieneImagen = imagenSrc !== '';

                    console.log(`üé® Renderizando item ${item.id}:`, {
                        nombre: item.name || item.nombre,
                        imagen: imagenSrc,
                        tieneImagen: tieneImagen
                    });

                    html += `
                        <div class="cart-item-drawer" data-id="${item.id}" style="display: flex; gap: 14px; padding: 18px; margin-bottom: 12px; border-radius: 12px; background: white; border: 1px solid #e5e7eb; transition: all 0.3s;">
                            ${tieneImagen ? `
                                <img src="${imagenSrc}"
                                     style="width: 85px; height: 85px; object-fit: contain; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 10px; padding: 10px; border: 1px solid #e5e7eb; flex-shrink: 0;"
                                     alt="${(item.name || item.nombre) || ''}"
                                     onerror="console.error('‚ùå Error cargando imagen:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="display: none; width: 85px; height: 85px; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 10px; align-items: center; justify-content: center; border: 1px solid #e5e7eb; flex-shrink: 0;">
                                    <i class="fas fa-image" style="font-size: 2rem; color: #d1d5db;"></i>
                                </div>
                            ` : `
                                <div style="width: 85px; height: 85px; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb; flex-shrink: 0;">
                                    <i class="fas fa-image" style="font-size: 2rem; color: #d1d5db;"></i>
                                </div>
                            `}
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 6px;">
                                <div style="font-size: 0.92rem; font-weight: 600; color: #1f2937; line-height: 1.4;">
                                    ${((item.name || item.nombre) || '').substring(0, 70)}${((item.name || item.nombre) || '').length > 70 ? '...' : ''}
                                </div>
                                <div style="color: #FF6B00; font-weight: 800; font-size: 1.15rem;">
                                    $${precio.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: auto;">
                                    <button class="qty-btn qty-decrease" data-id="${item.id}" style="background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); border: 2px solid #e5e7eb; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                                        <i class="fas fa-minus" style="color: #6b7280;"></i>
                                    </button>
                                    <span style="min-width: 35px; text-align: center; font-weight: 600; font-size: 1rem;">${cantidad}</span>
                                    <button class="qty-btn qty-increase" data-id="${item.id}" style="background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); border: 2px solid #e5e7eb; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                                        <i class="fas fa-plus" style="color: #6b7280;"></i>
                                    </button>
                                    <button class="qty-btn qty-delete" data-id="${item.id}" style="margin-left: auto; background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); border: 2px solid #e5e7eb; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #ef4444; transition: all 0.2s;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                cartDrawerBody.innerHTML = html;

                if (cartSubtotal) {
                    cartSubtotal.textContent = '$' + subtotal.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }

                console.log(`‚úÖ Carrito renderizado: ${items.length} items, subtotal: $${subtotal}`);

                // Reactivar event listeners
                if (typeof attachCartButtonEvents === 'function') attachCartButtonEvents();
                if (typeof updateCartBadge === 'function') updateCartBadge();
            };

            console.log('‚úÖ Sistema de renderizado del carrito actualizado');

            // Forzar actualizaci√≥n de botones con im√°genes
            setTimeout(function() {
                document.querySelectorAll('.btn-add-exito, .btn-add-to-cart').forEach(btn => {
                    if (!btn.dataset.imagen || btn.dataset.imagen === '') {
                        const card = btn.closest('.product-card-exito');
                        if (card) {
                            const img = getImageFromCard(card);
                            if (img) {
                                btn.dataset.imagen = normalizeUrl(img);
                                console.log(`üîß Bot√≥n actualizado con imagen: ${btn.dataset.imagen}`);
                            }
                        }
                    }
                });
                console.log('‚úÖ Todos los botones actualizados con im√°genes');
            }, 500);

            // Renderizar carrito inicial
            if (typeof window.renderCartItems === 'function') {
                setTimeout(() => window.renderCartItems(), 100);
            }
        });

        console.log('‚úÖ Sistema de im√°genes del carrito completamente inicializado');
    })();
    </script>
    <!-- Script FORZADO de renderizado con im√°genes -->
    <script>
    (function() {
        console.log('üî• SCRIPT FORZADO DE IM√ÅGENES INICIADO');

        // Esperar a que TODO est√© cargado
        setTimeout(function() {
            console.log('üî• Ejecutando renderizado forzado...');

            // Sobrescribir DEFINITIVAMENTE la funci√≥n renderCartItems
            window.renderCartItems = function() {
                console.log('üî• [FORZADO] Renderizando carrito...');

                const carrito = JSON.parse(localStorage.getItem('carrito_v1') || '{}');
                const items = Object.values(carrito);
                const cartDrawerBody = document.getElementById('cartDrawerBody');

                if (!cartDrawerBody) {
                    console.error('‚ùå cartDrawerBody no encontrado');
                    return;
                }

                if (items.length === 0) {
                    cartDrawerBody.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #6b7280;"><i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 16px;"></i><p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">Tu carrito est√° vac√≠o</p><p style="font-size: 0.9rem;">¬°Agrega productos incre√≠bles!</p></div>';
                    return;
                }

                let html = '';
                let subtotal = 0;

                items.forEach(item => {
                    const precio = parseFloat(item.price || item.precio || 0);
                    const cantidad = parseInt(item.qty || item.cantidad || 1);
                    subtotal += precio * cantidad;

                    // Obtener imagen - TODAS las fuentes posibles
                    let imagen = item.image || item.imagen || '';

                    console.log(`üñºÔ∏è DEBUG - Renderizando item ${item.id}:`, {
                        id: item.id,
                        nombre: item.name || item.nombre,
                        'item.image': item.image,
                        'item.imagen': item.imagen,
                        'imagen final': imagen,
                        'item completo': item
                    });

                    if (!imagen || imagen.trim() === '') {
                        console.warn('‚ö†Ô∏è Item sin imagen:', item.id, item.nombre || item.name);
                    } else {
                        // Normalizar URL
                        if (imagen.startsWith('/')) {
                            imagen = window.location.origin + imagen;
                        }
                        console.log('‚úÖ Imagen encontrada para', item.id, ':', imagen);
                    }

                    const tieneImagen = imagen && imagen.trim() !== '';

                    html += '<div class="cart-item-drawer" style="display: flex; gap: 14px; padding: 18px; margin-bottom: 12px; border-radius: 12px; background: white; border: 1px solid #e5e7eb;">';

                    // IMAGEN
                    if (tieneImagen) {
                        html += '<img src="' + imagen + '" class="cart-item-image" style="width: 85px; height: 85px; object-fit: contain; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 10px; padding: 10px; border: 1px solid #e5e7eb; flex-shrink: 0;" alt="' + (item.name || item.nombre || '') + '" onerror="console.error(\'Error cargando:\', this.src); this.style.display=\'none\';">';
                    } else {
                        html += '<div style="width: 85px; height: 85px; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb; flex-shrink: 0;"><i class="fas fa-image" style="font-size: 2rem; color: #d1d5db;"></i></div>';
                    }

                    // INFO
                    html += '<div class="cart-item-info" style="flex: 1; display: flex; flex-direction: column; gap: 6px;">';
                    html += '<div class="cart-item-name" style="font-size: 0.92rem; font-weight: 600; color: #1f2937; line-height: 1.4;">' + ((item.name || item.nombre) || '').substring(0, 70) + '</div>';
                    html += '<div class="cart-item-price" style="color: #FF6B00; font-weight: 800; font-size: 1.15rem;">$' + precio.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '</div>';

                    // CONTROLES
                    html += '<div class="cart-item-qty" style="display: flex; align-items: center; gap: 10px; margin-top: auto;">';
                    html += '<button class="qty-btn qty-decrease" data-id="' + item.id + '" style="background: white; border: 2px solid #e5e7eb; width: 32px; height: 32px; border-radius: 8px; cursor: pointer;"><i class="fas fa-minus"></i></button>';
                    html += '<span style="min-width: 35px; text-align: center; font-weight: 600;">' + cantidad + '</span>';
                    html += '<button class="qty-btn qty-increase" data-id="' + item.id + '" style="background: white; border: 2px solid #e5e7eb; width: 32px; height: 32px; border-radius: 8px; cursor: pointer;"><i class="fas fa-plus"></i></button>';
                    html += '<button class="qty-btn qty-delete" data-id="' + item.id + '" style="margin-left: auto; background: white; border: 2px solid #e5e7eb; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; color: #ef4444;"><i class="fas fa-trash"></i></button>';
                    html += '</div>';

                    html += '</div>'; // cart-item-info
                    html += '</div>'; // cart-item-drawer
                });

                cartDrawerBody.innerHTML = html;

                // Actualizar subtotal
                const cartSubtotal = document.getElementById('cartSubtotal');
                if (cartSubtotal) {
                    cartSubtotal.textContent = '$' + subtotal.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }

                console.log('‚úÖ [FORZADO] Carrito renderizado:', items.length, 'items');

                // Reactivar eventos
                if (typeof attachCartButtonEvents === 'function') {
                    attachCartButtonEvents();
                }
                if (typeof updateCartBadge === 'function') {
                    updateCartBadge();
                }
            };

            console.log('‚úÖ [FORZADO] Funci√≥n renderCartItems sobrescrita');

            // Renderizar inmediatamente
            if (typeof window.renderCartItems === 'function') {
                window.renderCartItems();
            }

        }, 1000); // Esperar 1 segundo despu√©s de que TODO cargue

        console.log('‚úÖ [FORZADO] Sistema configurado');
    })();
    </script>

    <!-- Scripts externos - Cargan despu√©s del sistema de im√°genes -->
    <script src="{% static 'js/productos-exito.js' %}"></script>
    <script src="{% static 'js/productos-landing.js' %}"></script>

    <!-- Script para modal de vaciar carrito -->
    <script>
    (function() {
        console.log('üóëÔ∏è Sistema de vaciar carrito iniciado');

        // Funci√≥n para mostrar modal de vaciar carrito
        function mostrarModalVaciarCarrito() {
            const modal = document.getElementById('emptyCartModal');
            const summary = document.getElementById('emptyCartSummary');

            if (!modal || !summary) {
                console.warn('‚ö†Ô∏è Modal de vaciar carrito no encontrado');
                return;
            }

            // Obtener carrito
            const carrito = JSON.parse(localStorage.getItem('carrito_v1') || '{}');
            const items = Object.values(carrito);

            if (items.length === 0) {
                alert('El carrito ya est√° vac√≠o');
                return;
            }

            // Calcular totales
            let totalItems = 0;
            let totalPrecio = 0;

            items.forEach(item => {
                const cantidad = parseInt(item.qty || item.cantidad || 1);
                const precio = parseFloat(item.price || item.precio || 0);
                totalItems += cantidad;
                totalPrecio += precio * cantidad;
            });

            // Construir resumen
            summary.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 10px;">Tu carrito contiene:</div>
                    <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 15px;">
                        <div style="background: #f3f4f6; padding: 15px 25px; border-radius: 12px;">
                            <div style="font-size: 2rem; font-weight: 800; color: #f59e0b;">${items.length}</div>
                            <div style="font-size: 0.85rem; color: #6b7280; font-weight: 600;">Productos</div>
                        </div>
                        <div style="background: #f3f4f6; padding: 15px 25px; border-radius: 12px;">
                            <div style="font-size: 2rem; font-weight: 800; color: #f59e0b;">${totalItems}</div>
                            <div style="font-size: 0.85rem; color: #6b7280; font-weight: 600;">Unidades</div>
                        </div>
                    </div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 12px; border: 2px solid #fbbf24;">
                        <div style="font-size: 0.85rem; color: #92400e; margin-bottom: 5px;">Total del Carrito</div>
                        <div style="font-size: 2.2rem; font-weight: 800; color: #d97706;">
                            $${totalPrecio.toLocaleString('es-CO', { minimumFractionDigits: 2 })}
                        </div>
                    </div>
                </div>

                <!-- Lista de productos -->
                <div style="max-height: 200px; overflow-y: auto; margin-top: 20px; padding: 10px; background: #f9fafb; border-radius: 12px;">
                    ${items.map(item => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                            <span style="font-size: 0.9rem; color: #374151; font-weight: 600;">
                                ${(item.name || item.nombre || '').substring(0, 30)}...
                            </span>
                            <span style="font-size: 0.85rem; color: #6b7280;">
                                x${item.qty || item.cantidad || 1}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;

            // Mostrar modal
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // Configurar botones
            const btnCancel = document.getElementById('btnCancelEmptyCart');
            const btnConfirm = document.getElementById('btnConfirmEmptyCart');

            // Limpiar eventos anteriores
            const newBtnCancel = btnCancel.cloneNode(true);
            const newBtnConfirm = btnConfirm.cloneNode(true);
            btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);
            btnConfirm.parentNode.replaceChild(newBtnConfirm, btnConfirm);

            // Agregar nuevos eventos
            newBtnCancel.addEventListener('click', () => {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
            });

            newBtnConfirm.addEventListener('click', () => {
                console.log('‚úÖ Vaciando carrito completo...');

                // Vaciar el carrito
                localStorage.setItem('carrito_v1', JSON.stringify({}));

                // Actualizar UI
                if (typeof window.renderCartItems === 'function') {
                    window.renderCartItems();
                }
                if (typeof updateCartBadge === 'function') {
                    updateCartBadge();
                }

                // Cerrar modal
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';

                // Mostrar mensaje de √©xito
                console.log('üéâ Carrito vaciado exitosamente');
            });

            // Cerrar al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Exponer funci√≥n globalmente
        window.mostrarModalVaciarCarrito = mostrarModalVaciarCarrito;

        // Event listener para el bot√≥n de vaciar carrito
        document.addEventListener('DOMContentLoaded', function() {
            const btnVaciarCarrito = document.getElementById('btnVaciarCarrito');
            if (btnVaciarCarrito) {
                btnVaciarCarrito.addEventListener('click', mostrarModalVaciarCarrito);
                console.log('‚úÖ Bot√≥n vaciar carrito configurado');
            }
        });

        // Tambi√©n escuchar despu√©s de que el drawer se muestre
        setTimeout(function() {
            const btnVaciarCarrito = document.getElementById('btnVaciarCarrito');
            if (btnVaciarCarrito && !btnVaciarCarrito.hasAttribute('data-configured')) {
                btnVaciarCarrito.addEventListener('click', mostrarModalVaciarCarrito);
                btnVaciarCarrito.setAttribute('data-configured', 'true');
                console.log('‚úÖ Bot√≥n vaciar carrito configurado (retry)');
            }
        }, 2000);

        console.log('‚úÖ Sistema de vaciar carrito listo');
    })();
    </script>
</body>
</html>

