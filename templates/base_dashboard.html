{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}DIGITSOFT{% endblock %} - Sistema de Gesti√≥n Empresarial</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

    <!-- Sidebar CSS -->
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">

    <!-- Theme Switcher CSS -->
    <link rel="stylesheet" href="{% static 'css/theme-switcher.css' %}">

    <!-- Accessibility CSS -->
    <link rel="stylesheet" href="{% static 'css/accessibility.css' %}">

    <!-- Floating Widgets CSS -->
    <link rel="stylesheet" href="{% static 'css/floating-widgets.css' %}">

    <!-- Responsive CSS -->
    <link rel="stylesheet" href="{% static 'css/responsive-global.css' %}">
    <link rel="stylesheet" href="{% static 'css/responsive-modulos.css' %}">
    <link rel="stylesheet" href="{% static 'css/responsive-fixes.css' %}">
    <link rel="stylesheet" href="{% static 'css/tablas-responsive.css' %}">
    <link rel="stylesheet" href="{% static 'css/modulos-fix-responsive.css' %}">
    <link rel="stylesheet" href="{% static 'css/z-index-fix.css' %}">

    <!-- CR√çTICO: Debe cargarse √∫ltimo para fix de clicks -->
    <link rel="stylesheet" href="{% static 'css/click-fix-critical.css' %}">

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-th-large"></i> M√≥dulos</h3>
            <button class="close-sidebar" id="closeSidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <!-- Principal -->
            <div class="sidebar-category">Principal</div>
            <li>
                <a href="{% url 'dashboard:index' %}" class="{% if request.resolver_match.url_name == 'index' %}active{% endif %}">
                    <i class="fas fa-home"></i> Dashboard
                </a>
            </li>

            <!-- Gesti√≥n de Clientes -->
            <div class="sidebar-category">Clientes & Servicios</div>
            <li>
                <a href="{% url 'clientes:lista' %}">
                    <i class="fas fa-users"></i> Gesti√≥n de Clientes
                </a>
            </li>
            <li>
                <a href="{% url 'tecnicos:lista' %}">
                    <i class="fas fa-user-tie"></i> Gesti√≥n de T√©cnicos
                </a>
            </li>
            <li>
                <a href="{% url 'ordenes:lista' %}">
                    <i class="fas fa-clipboard-list"></i> √ìrdenes de Servicio
                </a>
            </li>
            <li>
                <a href="{% url 'equipos:lista' %}">
                    <i class="fas fa-desktop"></i> Gesti√≥n de Equipos
                </a>
            </li>
            <li>
                <a href="{% url 'garantias:lista' %}">
                    <i class="fas fa-shield-alt"></i> Garant√≠as
                </a>
            </li>

            <!-- Inventario -->
            <div class="sidebar-category">Inventario & Proveedores</div>
            <li>
                <a href="{% url 'productos:lista' %}">
                    <i class="fas fa-box"></i> Gesti√≥n de Productos
                </a>
            </li>
            <li>
                <a href="{% url 'proveedores:lista' %}">
                    <i class="fas fa-truck"></i> Proveedores
                </a>
            </li>

            <!-- Ventas -->
            <div class="sidebar-category">Ventas & Facturaci√≥n</div>
            <li>
                <a href="{% url 'ventas:lista' %}">
                    <i class="fas fa-cash-register"></i> Gesti√≥n de Ventas
                </a>
            </li>
            <li>
                <a href="{% url 'compras:lista' %}">
                    <i class="fas fa-shopping-cart"></i> Gesti√≥n de Compras
                </a>
            </li>
            <li>
                <a href="{% url 'facturacion:lista' %}">
                    <i class="fas fa-file-invoice"></i> Facturaci√≥n
                </a>
            </li>

            <!-- E-commerce -->
            <div class="sidebar-category">E-commerce</div>
            <li>
                <a href="{% url 'ecommerce:productos' %}">
                    <i class="fas fa-store"></i> Tienda Online
                </a>
            </li>

            <!-- Administraci√≥n -->
            <div class="sidebar-category">Administraci√≥n</div>
            <li>
                <a href="{% url 'usuarios:listar_usuarios' %}">
                    <i class="fas fa-users"></i> Gesti√≥n de Usuarios
                </a>
            </li>
            <li>
                <a href="{% url 'usuarios:admin_gestionar_contrasenas' %}">
                    <i class="fas fa-user-lock"></i> Gesti√≥n de Contrase√±as
                </a>
            </li>

            <!-- Otros -->
            <div class="sidebar-category">Otros</div>
            <li>
                <a href="{% url 'capacitaciones:lista' %}">
                    <i class="fas fa-graduation-cap"></i> Capacitaciones
                </a>
            </li>
        </ul>
    </div>

    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="d-flex align-items-center gap-3">
                <div class="menu-toggle" id="menuToggle" style="display: flex !important; visibility: visible !important; opacity: 1 !important; cursor: pointer; padding: 12px 15px; border-radius: 10px; background: linear-gradient(135deg, #037dc4, #0f9bec); color: white; width: 50px; height: 50px; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(3, 125, 196, 0.4); z-index: 100; position: relative;">
                    <i class="fas fa-bars fa-lg" style="color: white; font-size: 1.5rem;"></i>
                </div>
                <div class="logo">
                    <h1><span>DIGIT</span>SOFT</h1>
                    <p>Sistema de Gesti√≥n Empresarial</p>
                </div>
            </div>

            <!-- Navigation Menu -->
            <nav class="navbar-menu">
                <ul class="nav-list">
                    <li><a href="{% url 'core:home' %}">Inicio</a></li>
                    <li><a href="{% url 'dashboard:index' %}">Dashboard</a></li>

                    <!-- M√≥dulos Dropdown -->
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle">
                            M√≥dulos <i class="fas fa-chevron-down"></i>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="{% url 'clientes:lista' %}"><i class="fas fa-users"></i> Clientes</a></li>
                            <li><a href="{% url 'tecnicos:lista' %}"><i class="fas fa-user-tie"></i> T√©cnicos</a></li>
                            <li><a href="{% url 'ordenes:lista' %}"><i class="fas fa-clipboard-list"></i> √ìrdenes</a></li>
                            <li><a href="{% url 'productos:lista' %}"><i class="fas fa-box"></i> Productos</a></li>
                            <li><a href="{% url 'ecommerce:productos' %}"><i class="fas fa-store"></i> E-commerce</a></li>
                            <li><a href="{% url 'proveedores:lista' %}"><i class="fas fa-truck"></i> Proveedores</a></li>
                            <li><a href="{% url 'garantias:lista' %}"><i class="fas fa-shield-alt"></i> Garant√≠as</a></li>
                            <li><a href="{% url 'compras:lista' %}"><i class="fas fa-shopping-cart"></i> Compras</a></li>
                            <li><a href="{% url 'ventas:lista' %}"><i class="fas fa-cash-register"></i> Ventas</a></li>
                            <li><a href="{% url 'facturacion:lista' %}"><i class="fas fa-file-invoice"></i> Facturaci√≥n</a></li>
                            <li><a href="{% url 'equipos:lista' %}"><i class="fas fa-desktop"></i> Equipos</a></li>
                            <li><a href="{% url 'capacitaciones:lista' %}"><i class="fas fa-graduation-cap"></i> Capacitaciones</a></li>
                        </ul>
                    </li>

                    <li><a href="{% url 'core:about' %}">Nosotros</a></li>
                    <li><a href="#" class="btn-contactanos">CONT√ÅCTANOS</a></li>
                </ul>
            </nav>

            <div class="header-actions">
                {% if user.is_authenticated %}
                    <!-- Bot√≥n del Carrito -->
                    <a href="{% url 'ecommerce:ver_carrito' %}" class="btn btn-success btn-sm me-2">
                        <i class="fas fa-shopping-cart"></i> Carrito
                        <span class="badge bg-light text-dark ms-1" id="header-carrito-count">0</span>
                    </a>

                    <!-- Bot√≥n ver tienda -->
                    <a href="{% url 'ecommerce:productos' %}" class="btn btn-info btn-sm me-2">
                        <i class="fas fa-store"></i> Tienda
                    </a>

                    <div class="user-info">
                        <div class="user-avatar">
                            {{ user.get_full_name|slice:":1"|upper|default:user.username|slice:":1"|upper }}
                        </div>
                        <span>{{ user.get_full_name|default:user.username }}</span>
                    </div>
                    <a href="{% url 'usuarios:logout' %}" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </a>
                {% else %}
                    <a href="{% url 'usuarios:login' %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
                    </a>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Main Wrapper -->
    <div class="main-wrapper">
        <!-- Mensajes -->
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i> {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Main Content -->
        <main class="main-content">
            {% block content %}{% endblock %}
        </main>

        <!-- Footer -->
        <footer>
            <div class="footer-content">
                <div class="footer-section">
                    <h3>DIGITSOFT</h3>
                    <p>Sistema integral de gesti√≥n empresarial. Soluciones tecnol√≥gicas para optimizar tu negocio.</p>
                    <p><i class="fas fa-map-marker-alt"></i> Calle 15 # 14-26, Duitama - Boyac√°</p>
                    <p><i class="fas fa-phone"></i> (+57) 3215434380</p>
                </div>

                <div class="footer-section">
                    <h3>Enlaces R√°pidos</h3>
                    <ul>
                        <li><a href="{% url 'dashboard:index' %}">Dashboard</a></li>
                        <li><a href="{% url 'clientes:lista' %}">Clientes</a></li>
                        <li><a href="{% url 'productos:lista' %}">Productos</a></li>
                        <li><a href="{% url 'ventas:lista' %}">Ventas</a></li>
                        <li><a href="{% url 'facturacion:lista' %}">Facturaci√≥n</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3>M√≥dulos</h3>
                    <ul>
                        <li><a href="{% url 'tecnicos:lista' %}">T√©cnicos</a></li>
                        <li><a href="{% url 'ordenes:lista' %}">√ìrdenes</a></li>
                        <li><a href="{% url 'proveedores:lista' %}">Proveedores</a></li>
                        <li><a href="{% url 'garantias:lista' %}">Garant√≠as</a></li>
                        <li><a href="{% url 'equipos:lista' %}">Equipos</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h3>Informaci√≥n</h3>
                    <p>Sistema basado en Django Framework</p>
                    <p>Centro Minero Regional Boyac√°</p>
                    <p><i class="fas fa-envelope"></i> info@digitsoft.com.co</p>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 DIGITSOFT. Todos los derechos reservados.</p>
            </div>
        </footer>
    </div>

    <!-- Widgets Flotantes Unificados (Accesibilidad + WhatsApp) -->
    {% include 'includes/floating_widgets_unified.html' %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Sidebar Toggle - Versi√≥n con debugging mejorado
        console.log('[Sidebar] ===== INICIANDO SISTEMA DE SIDEBAR =====');

        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const menuToggle = document.getElementById('menuToggle');
        const closeSidebar = document.getElementById('closeSidebar');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');

        console.log('[Sidebar] Verificando elementos:');
        console.log('[Sidebar] - sidebar:', sidebar ? '‚úÖ ENCONTRADO' : '‚ùå NO ENCONTRADO');
        console.log('[Sidebar] - sidebarOverlay:', sidebarOverlay ? '‚úÖ ENCONTRADO' : '‚ùå NO ENCONTRADO');
        console.log('[Sidebar] - menuToggle:', menuToggle ? '‚úÖ ENCONTRADO' : '‚ùå NO ENCONTRADO');
        console.log('[Sidebar] - closeSidebar:', closeSidebar ? '‚úÖ ENCONTRADO' : '‚ùå NO ENCONTRADO');
        console.log('[Sidebar] - N√∫mero de links:', sidebarLinks.length);

        if (!menuToggle) {
            console.error('[Sidebar] ‚ùå‚ùå‚ùå BOT√ìN DE MEN√ö NO ENCONTRADO ‚ùå‚ùå‚ùå');
            alert('ERROR: El bot√≥n del men√∫ no fue encontrado. Revisa la consola (F12).');
        } else {
            console.log('[Sidebar] ‚úÖ Bot√≥n encontrado:', menuToggle);
            console.log('[Sidebar] ‚úÖ Estilos del bot√≥n:', window.getComputedStyle(menuToggle).display);

            // Forzar visibilidad del bot√≥n
            menuToggle.style.display = 'flex';
            menuToggle.style.visibility = 'visible';
            menuToggle.style.opacity = '1';
            console.log('[Sidebar] ‚úÖ Visibilidad forzada en el bot√≥n');
        }

        // Funci√≥n para abrir el sidebar
        function openSidebar() {
            console.log('[Sidebar] üöÄ ABRIENDO SIDEBAR...');
            if (sidebar && sidebarOverlay) {
                sidebar.classList.add('open');
                sidebar.style.left = '0px';
                sidebarOverlay.classList.add('open');
                document.body.style.overflow = 'hidden';
                console.log('[Sidebar] ‚úÖ Sidebar abierto');
                console.log('[Sidebar] ‚úÖ Clases del sidebar:', sidebar.className);
                console.log('[Sidebar] ‚úÖ Left del sidebar:', sidebar.style.left);
            } else {
                console.error('[Sidebar] ‚ùå No se pudo abrir - elementos faltantes');
            }
        }

        // Funci√≥n para cerrar el sidebar
        function closeSidebarFunc() {
            console.log('[Sidebar] üö™ CERRANDO SIDEBAR...');
            if (sidebar && sidebarOverlay) {
                sidebar.classList.remove('open');
                sidebar.style.left = '-280px';
                sidebarOverlay.classList.remove('open');
                document.body.style.overflow = '';
                console.log('[Sidebar] ‚úÖ Sidebar cerrado');
            }
        }

        // Evento para abrir sidebar
        if (menuToggle) {
            console.log('[Sidebar] üìå Agregando event listener al bot√≥n...');
            menuToggle.addEventListener('click', function(e) {
                console.log('[Sidebar] üñ±Ô∏è ¬°CLICK EN EL BOT√ìN DE MEN√ö!');
                e.preventDefault();
                e.stopPropagation();
                openSidebar();
            });
            console.log('[Sidebar] ‚úÖ Event listener agregado');

            // Test de visibilidad
            console.log('[Sidebar] üìä Posici√≥n del bot√≥n:', menuToggle.getBoundingClientRect());
        }

        // Evento para cerrar sidebar (bot√≥n X)
        if (closeSidebar) {
            closeSidebar.addEventListener('click', closeSidebarFunc);
        }

        // Evento para cerrar sidebar (clic en overlay)
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', closeSidebarFunc);
        }

        // Cerrar sidebar al hacer clic en cualquier enlace
        sidebarLinks.forEach(link => {
            link.addEventListener('click', function() {
                setTimeout(closeSidebarFunc, 200);
            });
        });

        // Cerrar sidebar con tecla ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                closeSidebarFunc();
            }
        });

        // Marcar enlace activo en el sidebar
        const currentPath = window.location.pathname;
        sidebarLinks.forEach(link => {
            if (link.getAttribute('href') === currentPath) {
                link.parentElement.classList.add('active');
            }
        });

        // Auto-hide messages after 5 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.messages .alert');
            alerts.forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);

        // Animaci√≥n suave al hacer scroll
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>

    <!-- Theme Switcher JS -->
    <script src="{% static 'js/theme-switcher.js' %}"></script>

    <!-- Accessibility JS -->
    <script src="{% static 'js/accessibility.js' %}"></script>

    <!-- JavaScript del Carrito Global -->
    <script>
        // Actualizar contador del carrito al cargar cualquier p√°gina del dashboard
        document.addEventListener('DOMContentLoaded', function() {
            actualizarContadorCarritoHeader();
        });

        // Funci√≥n para actualizar el contador del header
        function actualizarContadorCarritoHeader() {
            const carrito = localStorage.getItem('carrito');
            const carritoObj = carrito ? JSON.parse(carrito) : {};
            const totalItems = Object.values(carritoObj).reduce((total, item) => total + item.cantidad, 0);

            const contador = document.getElementById('header-carrito-count');
            if (contador) {
                contador.textContent = totalItems;
                if (totalItems > 0) {
                    contador.classList.remove('bg-light', 'text-dark');
                    contador.classList.add('bg-warning', 'text-dark');
                } else {
                    contador.classList.remove('bg-warning');
                    contador.classList.add('bg-light', 'text-dark');
                }
            }
        }

        // Actualizar contador cuando se modifique el carrito
        window.addEventListener('storage', function(e) {
            if (e.key === 'carrito') {
                actualizarContadorCarritoHeader();
            }

        });
    </script>

    <!-- Responsive JavaScript -->
    <script src="{% static 'js/responsive.js' %}"></script>
    <script src="{% static 'js/tablas-responsive.js' %}"></script>

    {% block extra_js %}{% endblock %}
</body>
</html>

