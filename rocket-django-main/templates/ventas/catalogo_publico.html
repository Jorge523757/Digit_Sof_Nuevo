{% extends 'base.html' %}
{% block title %}DigitSoft - Catálogo de Productos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="text-primary">
                    <i class="fas fa-store"></i> Catálogo DigitSoft
                </h1>
                <a href="{% url 'ventas:ver_carrito' %}" class="btn btn-success">
                    <i class="fas fa-shopping-cart"></i> Ver Carrito
                    <span class="badge badge-light" id="contador-carrito">0</span>
                </a>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" class="row">
                        <div class="col-md-6">
                            <input type="text" name="q" class="form-control" placeholder="Buscar productos..." value="{{ query }}">
                        </div>
                        <div class="col-md-4">
                            <select name="categoria" class="form-control">
                                <option value="">Todas las categorías</option>
                                {% for categoria in categorias %}
                                    <option value="{{ categoria }}" {% if categoria == categoria_seleccionada %}selected{% endif %}>
                                        {{ categoria|title }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Grid de productos -->
            <div class="row">
                {% for producto in productos %}
                <div class="col-md-4 col-lg-3 mb-4">
                    <div class="card h-100 shadow-sm">
                        {% if producto.imagen %}
                            <img src="{{ producto.imagen.url }}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="{{ producto.nombre }}">
                        {% else %}
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                <i class="fas fa-image fa-3x text-muted"></i>
                            </div>
                        {% endif %}
                        
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ producto.nombre }}</h5>
                            <p class="card-text text-muted small">{{ producto.descripcion|truncatechars:80 }}</p>
                            
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge badge-secondary">{{ producto.categoria|title }}</span>
                                    {% if producto.marca %}
                                        <small class="text-muted">{{ producto.marca }}</small>
                                    {% endif %}
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="text-success mb-0">${{ producto.precio|floatformat:0 }}</h4>
                                    <span class="badge {% if producto.stock > 10 %}badge-success{% elif producto.stock > 0 %}badge-warning{% else %}badge-danger{% endif %}">
                                        Stock: {{ producto.stock }}
                                    </span>
                                </div>
                                
                                {% if producto.stock > 0 %}
                                    <button onclick="agregarAlCarrito({{ producto.id }}, '{{ producto.nombre }}')" 
                                            class="btn btn-primary btn-block">
                                        <i class="fas fa-cart-plus"></i> Agregar al carrito
                                    </button>
                                {% else %}
                                    <button class="btn btn-secondary btn-block" disabled>
                                        <i class="fas fa-times"></i> Sin stock
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No se encontraron productos</h4>
                        <p class="text-muted">Intenta con otros términos de búsqueda</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function agregarAlCarrito(productId, productName) {
    fetch(`{% url 'ventas:agregar_al_carrito' pk=0 %}`.replace('0', productId), {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            // Mostrar mensaje de éxito
            Swal.fire({
                icon: 'success',
                title: '¡Agregado!',
                text: `${productName} agregado al carrito`,
                timer: 1500,
                showConfirmButton: false
            });
            
            // Actualizar contador del carrito
            actualizarContadorCarrito();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo agregar el producto al carrito'
        });
    });
}

function actualizarContadorCarrito() {
    // Obtener cantidad de items del carrito desde localStorage o hacer petición AJAX
    fetch('{% url "ventas:ver_carrito" %}')
        .then(response => response.text())
        .then(html => {
            // Parsear la respuesta para obtener la cantidad (simplificado)
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const items = doc.querySelectorAll('.cart-item').length;
            document.getElementById('contador-carrito').textContent = items;
        })
        .catch(error => console.error('Error updating cart counter:', error));
}

// Actualizar contador al cargar la página
document.addEventListener('DOMContentLoaded', actualizarContadorCarrito);
</script>
{% endblock %}